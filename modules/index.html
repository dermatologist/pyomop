
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="OMOP CDM utils in Python">
      
      
        <meta name="author" content="Bell Eapen">
      
      
        <link rel="canonical" href="https://dermatologist.github.io/pyomop/modules/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="../pyomop_migrate/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Modules - pyomop</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#cdm6.cdm6_tables" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pyomop" class="md-header__button md-logo" aria-label="pyomop" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pyomop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Modules
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/dermatologist/pyomop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    dermatologist/pyomop
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pyomop" class="md-nav__button md-logo" aria-label="pyomop" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    pyomop
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/dermatologist/pyomop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    dermatologist/pyomop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Modules
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Modules
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cdm6.cdm6_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        cdm6_tables
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cdm54.cdm54_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        cdm54_tables
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#engine_factory" class="md-nav__link">
    <span class="md-ellipsis">
      
        engine_factory
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmEngineFactory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmEngineFactory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.async_session" class="md-nav__link">
    <span class="md-ellipsis">
      
        async_session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.base" class="md-nav__link">
    <span class="md-ellipsis">
      
        base
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.db" class="md-nav__link">
    <span class="md-ellipsis">
      
        db
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.host" class="md-nav__link">
    <span class="md-ellipsis">
      
        host
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.name" class="md-nav__link">
    <span class="md-ellipsis">
      
        name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.port" class="md-nav__link">
    <span class="md-ellipsis">
      
        port
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.pw" class="md-nav__link">
    <span class="md-ellipsis">
      
        pw
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.session" class="md-nav__link">
    <span class="md-ellipsis">
      
        session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.user" class="md-nav__link">
    <span class="md-ellipsis">
      
        user
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.dispose" class="md-nav__link">
    <span class="md-ellipsis">
      
        dispose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.init_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_models
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.print_connection_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_connection_info
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        llm_engine
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      
        CDMDatabase
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CDMDatabase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase.get_single_table_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_single_table_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase.get_table_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_table_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase.usable_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        usable_tables
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_engine.SQLDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      
        SQLDatabase
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query" class="md-nav__link">
    <span class="md-ellipsis">
      
        llm_query
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query.CdmLLMQuery" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmLLMQuery
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmLLMQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_query.CdmLLMQuery.query_engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        query_engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_query.CdmLLMQuery.tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        tools
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query.MyToolKit" class="md-nav__link">
    <span class="md-ellipsis">
      
        MyToolKit
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MyToolKit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_query.MyToolKit.get_tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_tools
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query.example_query_tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        example_query_tool
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loader" class="md-nav__link">
    <span class="md-ellipsis">
      
        loader
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmCsvLoader
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmCsvLoader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.apply_concept_mappings" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply_concept_mappings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.backfill_person_birth_fields" class="md-nav__link">
    <span class="md-ellipsis">
      
        backfill_person_birth_fields
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.fix_person_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        fix_person_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.update_person_gender_concept_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_person_gender_concept_id
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main.main_routine" class="md-nav__link">
    <span class="md-ellipsis">
      
        main_routine
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vocabulary" class="md-nav__link">
    <span class="md-ellipsis">
      
        vocabulary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmVocabulary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmVocabulary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.concept_code" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.concept_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.concept_name" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.domain_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        domain_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.vocabulary_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        vocabulary_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.create_vocab" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_vocab
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.get_concept" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_concept
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.get_concept_by_code" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_concept_by_code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.get_session" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.set_concept" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_concept
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.write_vocab" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_vocab
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vector.CdmVector" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmVector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmVector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector.CdmVector.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector.CdmVector.query_library" class="md-nav__link">
    <span class="md-ellipsis">
      
        query_library
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector.CdmVector.result_to_df" class="md-nav__link">
    <span class="md-ellipsis">
      
        result_to_df
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sqldict" class="md-nav__link">
    <span class="md-ellipsis">
      
        sqldict
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../pyomop_migrate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    pyomop-migrate
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changelog
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#cdm6.cdm6_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        cdm6_tables
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cdm54.cdm54_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        cdm54_tables
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#engine_factory" class="md-nav__link">
    <span class="md-ellipsis">
      
        engine_factory
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmEngineFactory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmEngineFactory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.async_session" class="md-nav__link">
    <span class="md-ellipsis">
      
        async_session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.base" class="md-nav__link">
    <span class="md-ellipsis">
      
        base
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.db" class="md-nav__link">
    <span class="md-ellipsis">
      
        db
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.host" class="md-nav__link">
    <span class="md-ellipsis">
      
        host
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.name" class="md-nav__link">
    <span class="md-ellipsis">
      
        name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.port" class="md-nav__link">
    <span class="md-ellipsis">
      
        port
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.pw" class="md-nav__link">
    <span class="md-ellipsis">
      
        pw
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.schema" class="md-nav__link">
    <span class="md-ellipsis">
      
        schema
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.session" class="md-nav__link">
    <span class="md-ellipsis">
      
        session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.user" class="md-nav__link">
    <span class="md-ellipsis">
      
        user
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.dispose" class="md-nav__link">
    <span class="md-ellipsis">
      
        dispose
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.init_models" class="md-nav__link">
    <span class="md-ellipsis">
      
        init_models
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#engine_factory.CdmEngineFactory.print_connection_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        print_connection_info
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        llm_engine
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      
        CDMDatabase
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CDMDatabase">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase.get_single_table_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_single_table_info
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase.get_table_columns" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_table_columns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_engine.CDMDatabase.usable_tables" class="md-nav__link">
    <span class="md-ellipsis">
      
        usable_tables
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_engine.SQLDatabase" class="md-nav__link">
    <span class="md-ellipsis">
      
        SQLDatabase
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query" class="md-nav__link">
    <span class="md-ellipsis">
      
        llm_query
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query.CdmLLMQuery" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmLLMQuery
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmLLMQuery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_query.CdmLLMQuery.query_engine" class="md-nav__link">
    <span class="md-ellipsis">
      
        query_engine
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_query.CdmLLMQuery.tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        tools
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query.MyToolKit" class="md-nav__link">
    <span class="md-ellipsis">
      
        MyToolKit
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MyToolKit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#llm_query.MyToolKit.get_tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_tools
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#llm_query.example_query_tool" class="md-nav__link">
    <span class="md-ellipsis">
      
        example_query_tool
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loader" class="md-nav__link">
    <span class="md-ellipsis">
      
        loader
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmCsvLoader
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmCsvLoader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.apply_concept_mappings" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply_concept_mappings
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.backfill_person_birth_fields" class="md-nav__link">
    <span class="md-ellipsis">
      
        backfill_person_birth_fields
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.fix_person_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        fix_person_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.load" class="md-nav__link">
    <span class="md-ellipsis">
      
        load
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loader.CdmCsvLoader.update_person_gender_concept_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        update_person_gender_concept_id
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main" class="md-nav__link">
    <span class="md-ellipsis">
      
        main
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#main.main_routine" class="md-nav__link">
    <span class="md-ellipsis">
      
        main_routine
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vocabulary" class="md-nav__link">
    <span class="md-ellipsis">
      
        vocabulary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmVocabulary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmVocabulary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.concept_code" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.concept_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.concept_name" class="md-nav__link">
    <span class="md-ellipsis">
      
        concept_name
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.domain_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        domain_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.vocabulary_id" class="md-nav__link">
    <span class="md-ellipsis">
      
        vocabulary_id
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.create_vocab" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_vocab
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.get_concept" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_concept
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.get_concept_by_code" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_concept_by_code
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.get_session" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_session
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.set_concept" class="md-nav__link">
    <span class="md-ellipsis">
      
        set_concept
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vocabulary.CdmVocabulary.write_vocab" class="md-nav__link">
    <span class="md-ellipsis">
      
        write_vocab
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vector" class="md-nav__link">
    <span class="md-ellipsis">
      
        vector
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#vector.CdmVector" class="md-nav__link">
    <span class="md-ellipsis">
      
        CdmVector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CdmVector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vector.CdmVector.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector.CdmVector.query_library" class="md-nav__link">
    <span class="md-ellipsis">
      
        query_library
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vector.CdmVector.result_to_df" class="md-nav__link">
    <span class="md-ellipsis">
      
        result_to_df
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sqldict" class="md-nav__link">
    <span class="md-ellipsis">
      
        sqldict
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Modules</h1>

<div class="doc doc-object doc-module">



<a id="cdm6.cdm6_tables"></a>
    <div class="doc doc-contents first">

        <p>Derivative based on the original work here: https://github.com/thehyve/omop-cdm/blob/main/src/omop_cdm/regular/cdm600/tables.py
Modifications made to this file:
- Removed support for schema.
- Added new tables</p>
<ul>
<li>Licensed under the Apache License, Version 2.0 (the "License");</li>
<li>you may not use this file except in compliance with the License.</li>
<li>You may obtain a copy of the License at
*</li>
<li>https://www.apache.org/licenses/LICENSE-2.0
*</li>
<li>Unless required by applicable law or agreed to in writing, software</li>
<li>distributed under the License is distributed on an "AS IS" BASIS,</li>
<li>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</li>
<li>See the License for the specific language governing permissions and</li>
<li>limitations under the License.</li>
</ul>










<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="cdm54.cdm54_tables"></a>
    <div class="doc doc-contents first">

        <p>Derivative based on the original work here: https://github.com/thehyve/omop-cdm/blob/main/src/omop_cdm/regular/cdm54/tables.py
Modifications made to this file:
- Removed support for schema.
- Added new tables</p>
<ul>
<li>Licensed under the Apache License, Version 2.0 (the "License");</li>
<li>you may not use this file except in compliance with the License.</li>
<li>You may obtain a copy of the License at
*</li>
<li>https://www.apache.org/licenses/LICENSE-2.0
*</li>
<li>Unless required by applicable law or agreed to in writing, software</li>
<li>distributed under the License is distributed on an "AS IS" BASIS,</li>
<li>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</li>
<li>See the License for the specific language governing permissions and</li>
<li>limitations under the License.</li>
</ul>










<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="engine_factory"></a>
    <div class="doc doc-contents first">

        <p>Engine and session factory for OMOP CDM databases.</p>
<p>This module provides an asynchronous SQLAlchemy engine factory with helpers to
create/init CDM schemas and obtain async sessions across supported backends
(SQLite, MySQL, PostgreSQL).</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="engine_factory.CdmEngineFactory" class="doc doc-heading">
            <code>CdmEngineFactory</code>


<a href="#engine_factory.CdmEngineFactory" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="object">object</span></code></p>



        <p>Factory to create async SQLAlchemy engines and sessions for OMOP CDM.</p>
<p>Supports SQLite (default), MySQL, and PostgreSQL. Exposes convenience
properties for the configured engine and async session maker.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>db</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database type: "sqlite", "mysql", or "pgsql".</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>host</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database host (ignored for SQLite).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>port</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database port (ignored for SQLite).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>user</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database user (ignored for SQLite).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pw</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database password (ignored for SQLite).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Database name or SQLite filename.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>PostgreSQL schema to use for CDM.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/engine_factory.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CdmEngineFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory to create async SQLAlchemy engines and sessions for OMOP CDM.</span>

<span class="sd">    Supports SQLite (default), MySQL, and PostgreSQL. Exposes convenience</span>
<span class="sd">    properties for the configured engine and async session maker.</span>

<span class="sd">    Args:</span>
<span class="sd">        db: Database type: &quot;sqlite&quot;, &quot;mysql&quot;, or &quot;pgsql&quot;.</span>
<span class="sd">        host: Database host (ignored for SQLite).</span>
<span class="sd">        port: Database port (ignored for SQLite).</span>
<span class="sd">        user: Database user (ignored for SQLite).</span>
<span class="sd">        pw: Database password (ignored for SQLite).</span>
<span class="sd">        name: Database name or SQLite filename.</span>
<span class="sd">        schema: PostgreSQL schema to use for CDM.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYOMOP_DB&quot;</span><span class="p">,</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYOMOP_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;cdm.sqlite&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">host</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYOMOP_HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;localhost&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">port</span> <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYOMOP_PORT&quot;</span><span class="p">,</span> <span class="s2">&quot;5432&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYOMOP_USER&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pw</span> <span class="o">=</span> <span class="n">pw</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYOMOP_PW&quot;</span><span class="p">,</span> <span class="s2">&quot;pass&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYOMOP_SCHEMA&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop and re-create all tables from provided metadata.</span>

<span class="sd">        This is mainly used for tests and quick local setups.</span>

<span class="sd">        Args:</span>
<span class="sd">            metadata: SQLAlchemy ``MetaData`` containing table definitions.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the engine has not been initialized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Database engine is not initialized.&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured database type (sqlite/mysql/pgsql).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured database host (if applicable).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured database port (if applicable).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured database name or SQLite filename.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured database user (if applicable).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured database password (if applicable).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pw</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the configured schema (PostgreSQL).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return automapped classes when an engine exists, otherwise None.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Not self_engine</span>
            <span class="n">Base</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>
            <span class="n">Base</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="n">reflect</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Base</span><span class="o">.</span><span class="n">classes</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">engine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create or return the async engine for the configured backend.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Async engine instance bound to the configured database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
            <span class="c1"># Schemas are not supported for SQLite; warn if a non-default schema was provided</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;public&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Schema is not supported for SQLite; ignoring schema=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span>
                <span class="s2">&quot;sqlite+aiosqlite:///&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="n">pool_pre_ping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">pool_recycle</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;mysql&quot;</span><span class="p">:</span>
            <span class="c1"># Schemas are not supported for MySQL in the same way as PostgreSQL; warn and ignore</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;public&quot;</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Schema is not supported for MySQL; ignoring schema=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">mysql_url</span> <span class="o">=</span> <span class="s2">&quot;mysql://</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="n">mysql_url</span> <span class="o">=</span> <span class="n">mysql_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span>
                <span class="n">mysql_url</span><span class="p">,</span> <span class="n">isolation_level</span><span class="o">=</span><span class="s2">&quot;READ UNCOMMITTED&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;pgsql&quot;</span><span class="p">:</span>
            <span class="n">pgsql_url</span> <span class="o">=</span> <span class="s2">&quot;postgresql+asyncpg://</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span>
            <span class="n">pgsql_url</span> <span class="o">=</span> <span class="n">pgsql_url</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
            <span class="p">)</span>
            <span class="n">connect_args</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># If a schema is provided, set the PostgreSQL search_path so that all</span>
            <span class="c1"># operations (reflection, DDL/DML) use this schema by default.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">connect_args</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;server_settings&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;search_path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span><span class="n">pgsql_url</span><span class="p">,</span> <span class="n">connect_args</span><span class="o">=</span><span class="n">connect_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Unknown DB type; create no engine and warn</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown database type &#39;</span><span class="si">%s</span><span class="s2">&#39;no engine created.&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return an async_sessionmaker for creating AsyncSession objects.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">async_session</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">async_session</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">async_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias for session to maintain backward compatibility.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">async_session</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">async_session</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispose of the engine and close all connections.</span>

<span class="sd">        This should be called when done with database operations to</span>
<span class="sd">        ensure proper cleanup and avoid hanging.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@db</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@port</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_port</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@host</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_host</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@user</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@pw</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pw</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@schema</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">print_connection_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a string with the connection details (for logging/display).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
            <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="n">_server</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s2">&quot;cdm.sqlite&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;connectionDetails &lt;- DatabaseConnector::createConnectionDetails(</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s1">&#39;    dbms = &quot;sqlite&quot;, server = &quot;</span><span class="si">{</span><span class="n">_server</span><span class="si">}</span><span class="s1">&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;mysql&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;MySQL database &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&#39; on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="si">}</span><span class="s2"> as user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;pgsql&quot;</span><span class="p">:</span>
            <span class="n">schema_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, schema &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;PostgreSQL database &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&#39; on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="si">}</span><span class="s2"> as user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">schema_info</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No valid database connection configured.&quot;</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.async_session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">async_session</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.async_session" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Alias for session to maintain backward compatibility.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.base" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">base</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.base" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return automapped classes when an engine exists, otherwise None.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.db" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">db</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.db" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the configured database type (sqlite/mysql/pgsql).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.engine" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">engine</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.engine" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create or return the async engine for the configured backend.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Async engine instance bound to the configured database.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.host" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">host</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.host" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the configured database host (if applicable).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">name</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.name" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the configured database name or SQLite filename.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.port" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">port</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.port" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the configured database port (if applicable).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.pw" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pw</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.pw" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the configured database password (if applicable).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.schema" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">schema</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.schema" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the configured schema (PostgreSQL).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">session</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.session" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return an async_sessionmaker for creating AsyncSession objects.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="engine_factory.CdmEngineFactory.user" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">user</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.user" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the configured database user (if applicable).</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="engine_factory.CdmEngineFactory.dispose" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dispose</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.dispose" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Dispose of the engine and close all connections.</p>
<p>This should be called when done with database operations to
ensure proper cleanup and avoid hanging.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/engine_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dispose of the engine and close all connections.</span>

<span class="sd">    This should be called when done with database operations to</span>
<span class="sd">    ensure proper cleanup and avoid hanging.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="engine_factory.CdmEngineFactory.init_models" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">init_models</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#engine_factory.CdmEngineFactory.init_models" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Drop and re-create all tables from provided metadata.</p>
<p>This is mainly used for tests and quick local setups.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>metadata</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQLAlchemy <code>MetaData</code> containing table definitions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the engine has not been initialized.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/engine_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">init_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Drop and re-create all tables from provided metadata.</span>

<span class="sd">    This is mainly used for tests and quick local setups.</span>

<span class="sd">    Args:</span>
<span class="sd">        metadata: SQLAlchemy ``MetaData`` containing table definitions.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the engine has not been initialized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Database engine is not initialized.&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="engine_factory.CdmEngineFactory.print_connection_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">print_connection_info</span><span class="p">()</span></code>

<a href="#engine_factory.CdmEngineFactory.print_connection_info" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return a string with the connection details (for logging/display).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/engine_factory.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">print_connection_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a string with the connection details (for logging/display).&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">:</span>
        <span class="n">current_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">_server</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_directory</span><span class="p">,</span> <span class="s2">&quot;cdm.sqlite&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;connectionDetails &lt;- DatabaseConnector::createConnectionDetails(</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s1">&#39;    dbms = &quot;sqlite&quot;, server = &quot;</span><span class="si">{</span><span class="n">_server</span><span class="si">}</span><span class="s1">&quot;)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;mysql&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;MySQL database &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&#39; on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="si">}</span><span class="s2"> as user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="s2">&quot;pgsql&quot;</span><span class="p">:</span>
        <span class="n">schema_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;, schema &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;PostgreSQL database &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="si">}</span><span class="s2">&#39; on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_port</span><span class="si">}</span><span class="s2"> as user &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="si">}</span><span class="s2">&#39;</span><span class="si">{</span><span class="n">schema_info</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;No valid database connection configured.&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="llm_engine"></a>
    <div class="doc doc-contents first">

        <p>LLM-oriented SQLDatabase wrapper for OMOP CDM.</p>
<p>This module provides utilities for connecting LLMs to OMOP CDM databases
using langchain's SQL toolkit and agents. It uses the OMOP CDM metadata
from this package's SQLAlchemy models to enable LLM-powered query components
to reason about available tables, columns, and foreign keys.</p>
<p>This file is import-safe even when the optional LLM extras are not installed;
in that case, attempting to instantiate <code>CDMDatabase</code> will raise a clear
ImportError directing you to install <code>pyomop[llm]</code>.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="llm_engine.CDMDatabase" class="doc doc-heading">
            <code>CDMDatabase</code>


<a href="#llm_engine.CDMDatabase" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="SQLDatabase (llm_engine.SQLDatabase)" href="#llm_engine.SQLDatabase">SQLDatabase</a></code></p>



        <p>OMOP-aware SQLDatabase for LLM query engines.</p>
<p>This class wraps langchain's <code>SQLDatabase</code> to use the OMOP CDM
SQLAlchemy metadata bundled with this package, making it easy to expose
concise schema information to LLM components.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>engine</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.engine.Engine">Engine</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQLAlchemy <code>Engine</code> connected to the OMOP database.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional database schema name.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ignore_tables</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Tables to hide from the LLM context.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_tables</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="str">str</span>] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Explicit subset of tables to expose.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_rows_in_table_info</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of sample rows to include in table info.</p>
              </div>
            </td>
            <td>
                  <code>3</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_string_length</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Max length of generated descriptions.</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OMOP CDM version label ("cdm54" or "cdm6").</p>
              </div>
            </td>
            <td>
                  <code>&#39;cdm54&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/llm_engine.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CDMDatabase</span><span class="p">(</span><span class="n">SQLDatabase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;OMOP-aware SQLDatabase for LLM query engines.</span>

<span class="sd">    This class wraps langchain&#39;s ``SQLDatabase`` to use the OMOP CDM</span>
<span class="sd">    SQLAlchemy metadata bundled with this package, making it easy to expose</span>
<span class="sd">    concise schema information to LLM components.</span>

<span class="sd">    Args:</span>
<span class="sd">        engine: SQLAlchemy ``Engine`` connected to the OMOP database.</span>
<span class="sd">        schema: Optional database schema name.</span>
<span class="sd">        ignore_tables: Tables to hide from the LLM context.</span>
<span class="sd">        include_tables: Explicit subset of tables to expose.</span>
<span class="sd">        sample_rows_in_table_info: Number of sample rows to include in table info.</span>
<span class="sd">        max_string_length: Max length of generated descriptions.</span>
<span class="sd">        version: OMOP CDM version label (&quot;cdm54&quot; or &quot;cdm6&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
        <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ignore_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">include_tables</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_rows_in_table_info</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">max_string_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
        <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cdm54&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_LLM_AVAILABLE</span><span class="p">:</span>  <span class="c1"># pragma: no cover - import-safe guard</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;Install &#39;pyomop[llm]&#39; to use LLM features.&quot;</span><span class="p">)</span>

        <span class="c1"># Basic configuration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_string_length</span> <span class="o">=</span> <span class="n">max_string_length</span>

        <span class="k">if</span> <span class="n">include_tables</span> <span class="ow">and</span> <span class="n">ignore_tables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both include_tables and ignore_tables&quot;</span><span class="p">)</span>

        <span class="c1"># Load OMOP metadata for the chosen version</span>
        <span class="n">Base</span><span class="p">:</span> <span class="n">Any</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">==</span> <span class="s2">&quot;cdm6&quot;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm6</span><span class="w"> </span><span class="kn">import</span> <span class="n">Base</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm54</span><span class="w"> </span><span class="kn">import</span> <span class="n">Base</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">MetaData</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># All known tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># Validate include/ignore lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_include_tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">include_tables</span><span class="p">)</span> <span class="k">if</span> <span class="n">include_tables</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_tables</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_tables</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;include_tables </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2"> not found in OMOP metadata&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ignore_tables</span><span class="p">)</span> <span class="k">if</span> <span class="n">ignore_tables</span> <span class="k">else</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_tables</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_tables</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ignore_tables </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2"> not found in OMOP metadata&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_tables</span><span class="p">:</span>
            <span class="n">usable</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_include_tables</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_tables</span><span class="p">:</span>
            <span class="n">usable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore_tables</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usable</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_tables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_usable_tables</span> <span class="o">=</span> <span class="n">usable</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample_rows_in_table_info</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;sample_rows_in_table_info must be an integer&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sample_rows_in_table_info</span> <span class="o">=</span> <span class="n">sample_rows_in_table_info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="c1"># Initialize parent SQLDatabase</span>
        <span class="c1"># Convert AsyncEngine to sync if needed (langchain requires sync engine)</span>
        <span class="n">parent_engine</span><span class="p">:</span> <span class="n">Engine</span>
        <span class="k">if</span> <span class="n">AsyncEngine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">AsyncEngine</span><span class="p">):</span>
            <span class="n">url_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
            <span class="c1"># Convert common async driver URLs to sync variants</span>
            <span class="n">url_str</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">url_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+aiosqlite&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+asyncpg&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+psycopg_async&quot;</span><span class="p">,</span> <span class="s2">&quot;+psycopg2&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">parent_engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">url_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">engine</span><span class="o">=</span><span class="n">parent_engine</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">include_tables</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usable_tables</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_usable_tables</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">sample_rows_in_table_info</span><span class="o">=</span><span class="n">sample_rows_in_table_info</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># --- Helper methods for LLM context ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_table_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of column names for a table.</span>

<span class="sd">        This uses the OMOP SQLAlchemy ``MetaData`` instead of DB inspector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_single_table_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a concise description of columns and foreign keys for a table.</span>

<span class="sd">        The format is compatible with langchain&#39;s SQL components.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;Table &#39;</span><span class="si">{table_name}</span><span class="s2">&#39; has columns: </span><span class="si">{columns}</span><span class="s2">, and foreign keys: </span><span class="si">{foreign_keys}</span><span class="s2">.&quot;</span>
        <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">foreign_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="si">!s}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
                <span class="n">foreign_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">fk</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fk</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="n">column_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">fk_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">foreign_keys</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_str</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">fk_str</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">usable_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the sorted list of tables exposed to the LLM.</span>

<span class="sd">        This respects include/ignore settings passed at initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usable_tables</span><span class="p">)</span>

    <span class="c1"># Backwards compat helper name used in some code paths</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_usable_table_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>  <span class="c1"># pragma: no cover - thin wrapper</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">usable_tables</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="llm_engine.CDMDatabase.get_single_table_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_single_table_info</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></code>

<a href="#llm_engine.CDMDatabase.get_single_table_info" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return a concise description of columns and foreign keys for a table.</p>
<p>The format is compatible with langchain's SQL components.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/llm_engine.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_single_table_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a concise description of columns and foreign keys for a table.</span>

<span class="sd">    The format is compatible with langchain&#39;s SQL components.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;Table &#39;</span><span class="si">{table_name}</span><span class="s2">&#39; has columns: </span><span class="si">{columns}</span><span class="s2">, and foreign keys: </span><span class="si">{foreign_keys}</span><span class="s2">.&quot;</span>
    <span class="n">columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">foreign_keys</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="si">!s}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">column</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
            <span class="n">foreign_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">fk</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">fk</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="n">column_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">fk_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">foreign_keys</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">column_str</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">fk_str</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_engine.CDMDatabase.get_table_columns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_table_columns</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></code>

<a href="#llm_engine.CDMDatabase.get_table_columns" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return list of column names for a table.</p>
<p>This uses the OMOP SQLAlchemy <code>MetaData</code> instead of DB inspector.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/llm_engine.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_table_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return list of column names for a table.</span>

<span class="sd">    This uses the OMOP SQLAlchemy ``MetaData`` instead of DB inspector.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_name</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="llm_engine.CDMDatabase.usable_tables" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">usable_tables</span><span class="p">()</span></code>

<a href="#llm_engine.CDMDatabase.usable_tables" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the sorted list of tables exposed to the LLM.</p>
<p>This respects include/ignore settings passed at initialization.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/llm_engine.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">usable_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the sorted list of tables exposed to the LLM.</span>

<span class="sd">    This respects include/ignore settings passed at initialization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_usable_tables</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llm_engine.SQLDatabase" class="doc doc-heading">
            <code>SQLDatabase</code>


<a href="#llm_engine.SQLDatabase" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Minimal stub to allow import without LLM extras.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/llm_engine.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SQLDatabase</span><span class="p">:</span>  <span class="c1"># type: ignore[no-redef]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Minimal stub to allow import without LLM extras.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="llm_query"></a>
    <div class="doc doc-contents first">

        <p>LLM query utilities over the OMOP CDM schema.</p>
<p>This module wires langchain components to an OMOP-aware <code>CDMDatabase</code> so
you can build SQL query engines that know about your CDM tables. All LLM-related
imports are optional and performed lazily at runtime.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="llm_query.CdmLLMQuery" class="doc doc-heading">
            <code>CdmLLMQuery</code>


<a href="#llm_query.CdmLLMQuery" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Helper that prepares an LLM-backed SQL query engine for OMOP.</p>
<p>It constructs an SQL agent that can generate and execute SQL queries
against OMOP CDM tables using an LLM.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sql_database</code>
            </td>
            <td>
                  <code><span title="llm_query.llm_engine.CDMDatabase">CDMDatabase</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A <code>CDMDatabase</code> instance connected to the OMOP DB.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>llm</code>
            </td>
            <td>
                  <code><span title="langchain_core.language_models.BaseLanguageModel">BaseLanguageModel</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A langchain LLM instance (BaseLanguageModel).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Reserved for future expansion.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/llm_query.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CdmLLMQuery</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper that prepares an LLM-backed SQL query engine for OMOP.</span>

<span class="sd">    It constructs an SQL agent that can generate and execute SQL queries</span>
<span class="sd">    against OMOP CDM tables using an LLM.</span>

<span class="sd">    Args:</span>
<span class="sd">        sql_database: A ``CDMDatabase`` instance connected to the OMOP DB.</span>
<span class="sd">        llm: A langchain LLM instance (BaseLanguageModel).</span>
<span class="sd">        **kwargs: Reserved for future expansion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sql_database</span><span class="p">:</span> <span class="n">CDMDatabase</span><span class="p">,</span>
        <span class="n">llm</span><span class="p">:</span> <span class="n">BaseLanguageModel</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sql_database</span> <span class="o">=</span> <span class="n">sql_database</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_llm</span> <span class="o">=</span> <span class="n">llm</span>

        <span class="c1"># Create SQL toolkit and agent</span>
        <span class="n">toolkit</span> <span class="o">=</span> <span class="n">MyToolKit</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">sql_database</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span> <span class="o">=</span> <span class="n">toolkit</span><span class="o">.</span><span class="n">get_tools</span><span class="p">()</span>

        <span class="c1"># Create SQL agent using the default agent type</span>
        <span class="c1"># This is more flexible and works with various LLM types</span>
        <span class="c1"># Use agent_executor_kwargs to enable error handling</span>
        <span class="c1"># Disable streaming for tool-calling agents to avoid &quot;Tools not supported in streaming mode&quot; error</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">llm</span><span class="o">.</span><span class="n">streaming</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># type: ignore</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># Some LLMs don&#39;t support setting streaming directly</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span> <span class="o">=</span> <span class="n">create_sql_agent</span><span class="p">(</span>
            <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">,</span>
            <span class="n">toolkit</span><span class="o">=</span><span class="n">toolkit</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">agent_type</span><span class="o">=</span><span class="s2">&quot;tool-calling&quot;</span><span class="p">,</span>
            <span class="n">agent_executor_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;handle_parsing_errors&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># The agent itself is the query engine for langchain &gt;1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_query_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_agent</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List of SQL tools available in the query engine.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tools</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">query_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;An SQL agent executor over the CDM tables.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_query_engine</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="llm_query.CdmLLMQuery.query_engine" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query_engine</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#llm_query.CdmLLMQuery.query_engine" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>An SQL agent executor over the CDM tables.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="llm_query.CdmLLMQuery.tools" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">tools</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#llm_query.CdmLLMQuery.tools" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>List of SQL tools available in the query engine.</p>

    </div>

</div>






  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="llm_query.MyToolKit" class="doc doc-heading">
            <code>MyToolKit</code>


<a href="#llm_query.MyToolKit" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="langchain_community.agent_toolkits.sql.toolkit.SQLDatabaseToolkit">SQLDatabaseToolkit</span></code></p>



        <p>Custom toolkit that includes the example query tool.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/llm_query.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MyToolKit</span><span class="p">(</span><span class="n">SQLDatabaseToolkit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom toolkit that includes the example query tool.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">CDMDatabase</span><span class="p">,</span> <span class="n">llm</span><span class="p">:</span> <span class="n">BaseLanguageModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">llm</span><span class="o">=</span><span class="n">llm</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the list of tools including the example query tool.&quot;&quot;&quot;</span>
        <span class="n">tools</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_tools</span><span class="p">()</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_query_tool</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="llm_query.MyToolKit.get_tools" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_tools</span><span class="p">()</span></code>

<a href="#llm_query.MyToolKit.get_tools" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get the list of tools including the example query tool.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/llm_query.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_tools</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the list of tools including the example query tool.&quot;&quot;&quot;</span>
    <span class="n">tools</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_tools</span><span class="p">()</span>
    <span class="n">tools</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example_query_tool</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tools</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="llm_query.example_query_tool" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">example_query_tool</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></code>

<a href="#llm_query.example_query_tool" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Generate a couple of example queries for the given table name.
This will help you understand how to formulate queries for the OMOP CDM.
Use this when sql_db_query_checker tool flags an invalid query.
Args:
    table_name: The name of the OMOP CDM table from "person", "condition_occurrence", "condition_era", "drug_exposure", "drug_era", "observation".
Returns:
    A string with example queries for the table.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/llm_query.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">example_query_tool</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a couple of example queries for the given table name.</span>
<span class="sd">    This will help you understand how to formulate queries for the OMOP CDM.</span>
<span class="sd">    Use this when sql_db_query_checker tool flags an invalid query.</span>
<span class="sd">    Args:</span>
<span class="sd">        table_name: The name of the OMOP CDM table from &quot;person&quot;, &quot;condition_occurrence&quot;, &quot;condition_era&quot;, &quot;drug_exposure&quot;, &quot;drug_era&quot;, &quot;observation&quot;.</span>
<span class="sd">    Returns:</span>
<span class="sd">        A string with example queries for the table.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">example</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;person&quot;</span><span class="p">:</span>
            <span class="c1"># read the following markdown file from the website and return its content</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/person/PE02.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/person/PE03.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;condition_occurrence&quot;</span><span class="p">:</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/condition_occurrence/CO01.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/condition_occurrence/CO05.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;condition_era&quot;</span><span class="p">:</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/condition_era/CE01.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/condition_era/CE02.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;drug_exposure&quot;</span><span class="p">:</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/drug_exposure/DEX01.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/drug_exposure/DEX02.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;drug_era&quot;</span><span class="p">:</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/drug_era/DER01.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">example</span> <span class="o">+=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/drug_era/DER04.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">elif</span> <span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;observation&quot;</span><span class="p">:</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/observation/O01.md&quot;</span>
            <span class="p">)</span><span class="o">.</span><span class="n">text</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error fetching example queries for </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dynamic prompt tool called for table: </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Example returned: </span><span class="si">{</span><span class="n">example</span><span class="p">[:</span><span class="mi">200</span><span class="p">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;(empty)&#39;</span><span class="si">}</span><span class="s2">...&quot;</span>
    <span class="p">)</span>  <span class="c1"># Log first 200 characters</span>
    <span class="k">return</span> <span class="n">example</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="loader"></a>
    <div class="doc doc-contents first">

        <p>CSV-to-OMOP loader.</p>
<p>This module implements a flexible CSV loader that can populate multiple OMOP
CDM tables according to a JSON mapping file. It also performs helpful cleanup
operations like foreign key normalization, birthdate backfilling, gender
mapping, and concept code lookups.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="loader.CdmCsvLoader" class="doc doc-heading">
            <code>CdmCsvLoader</code>


<a href="#loader.CdmCsvLoader" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Load a single CSV into multiple OMOP CDM tables using a JSON mapping file.</p>
<p>Mapping file format (JSON):</p>
<p>{
  "csv_key": "patient_id",            # optional, CSV column that contains the patient/person identifier
  "tables": [
    {
      "name": "cohort",              # target table name as in the database
      "filters": [                     # optional row filters applied to CSV before mapping
        {"column": "resourceType", "equals": "Encounter"}
      ],
      "columns": {                     # mapping of target_table_column -&gt; value
        "cohort_definition_id": {"const": 1},              # constant value
        "subject_id": "patient_id",                         # copy from CSV column
        "cohort_start_date": "period.start",                # copy from CSV column
        "cohort_end_date": "period.end"                     # copy from CSV column
      }
    }
  ]
}</p>


<details class="notes" open>
  <summary>Notes</summary>
  <ul>
<li>Constants are provided via {"const": value}.</li>
<li>If a required column is missing from mapping, it's left as None (DB default or nullable required).</li>
<li>Primary keys that are Integer types will autoincrement where supported (SQLite/PostgreSQL typical behavior).</li>
<li>Dates/times are converted to proper Python types where possible based on reflected column types.</li>
</ul>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/loader.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CdmCsvLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a single CSV into multiple OMOP CDM tables using a JSON mapping file.</span>

<span class="sd">    Mapping file format (JSON):</span>

<span class="sd">    {</span>
<span class="sd">      &quot;csv_key&quot;: &quot;patient_id&quot;,            # optional, CSV column that contains the patient/person identifier</span>
<span class="sd">      &quot;tables&quot;: [</span>
<span class="sd">        {</span>
<span class="sd">          &quot;name&quot;: &quot;cohort&quot;,              # target table name as in the database</span>
<span class="sd">          &quot;filters&quot;: [                     # optional row filters applied to CSV before mapping</span>
<span class="sd">            {&quot;column&quot;: &quot;resourceType&quot;, &quot;equals&quot;: &quot;Encounter&quot;}</span>
<span class="sd">          ],</span>
<span class="sd">          &quot;columns&quot;: {                     # mapping of target_table_column -&gt; value</span>
<span class="sd">            &quot;cohort_definition_id&quot;: {&quot;const&quot;: 1},              # constant value</span>
<span class="sd">            &quot;subject_id&quot;: &quot;patient_id&quot;,                         # copy from CSV column</span>
<span class="sd">            &quot;cohort_start_date&quot;: &quot;period.start&quot;,                # copy from CSV column</span>
<span class="sd">            &quot;cohort_end_date&quot;: &quot;period.end&quot;                     # copy from CSV column</span>
<span class="sd">          }</span>
<span class="sd">        }</span>
<span class="sd">      ]</span>
<span class="sd">    }</span>

<span class="sd">    Notes:</span>
<span class="sd">      - Constants are provided via {&quot;const&quot;: value}.</span>
<span class="sd">      - If a required column is missing from mapping, it&#39;s left as None (DB default or nullable required).</span>
<span class="sd">      - Primary keys that are Integer types will autoincrement where supported (SQLite/PostgreSQL typical behavior).</span>
<span class="sd">      - Dates/times are converted to proper Python types where possible based on reflected column types.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdm_engine_factory</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cdm54&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a loader bound to a specific database engine.</span>

<span class="sd">        Args:</span>
<span class="sd">            cdm_engine_factory: An initialized ``CdmEngineFactory``.</span>
<span class="sd">            version: OMOP CDM version label (&quot;cdm54&quot; or &quot;cdm6&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cdm</span> <span class="o">=</span> <span class="n">cdm_engine_factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">cdm_engine_factory</span><span class="o">.</span><span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maker</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="n">async_scoped_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maker</span><span class="p">,</span> <span class="n">scopefunc</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">version</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield a scoped async session bound to the engine.&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_automap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">AsyncConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AutomapBase</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reflect the database and return an automapped base.&quot;&quot;&quot;</span>
        <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_prepare</span><span class="p">(</span><span class="n">sync_conn</span><span class="p">):</span>
            <span class="n">automap</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">autoload_with</span><span class="o">=</span><span class="n">sync_conn</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">_prepare</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">automap</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_coerce_record_to_table_types</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">table</span><span class="p">,</span>
        <span class="n">rec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">force_text_fields</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coerce a record&#39;s values to the SQL types defined by the target OMOP table.</span>

<span class="sd">        Rules:</span>
<span class="sd">        - Strings/Text: cast to str; lists/tuples joined by comma; dicts JSON-serialized; enforce max length if defined.</span>
<span class="sd">        - Integers/Numerics: tolerant numeric parsing; None if unparsable.</span>
<span class="sd">        - Dates/DateTimes: parsed via pandas; DateTime normalized to UTC-naive.</span>
<span class="sd">        - Forced TEXT fields: certain columns are always stringified (e.g., codes arrays). The list comes</span>
<span class="sd">          from mapping[&quot;force_text_fields&quot;].</span>

<span class="sd">        This is applied just before insert to ensure DB type compatibility.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Columns that should always be treated as TEXT regardless of inferred type</span>
        <span class="n">force_text</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">force_text_fields</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># Local helper: stringify numbers without trailing .0 (e.g., 1.0 -&gt; &quot;1&quot;)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_s</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Decimal</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">to_integral_value</span><span class="p">():</span>
                        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="c1"># Normalize to drop insignificant trailing zeros</span>
                    <span class="k">return</span> <span class="nb">format</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">normalize</span><span class="p">(),</span> <span class="s2">&quot;f&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">type</span>

            <span class="c1"># Force certain fields to TEXT</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">force_text</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">sval</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_s</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>

                        <span class="n">sval</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">sval</span> <span class="o">=</span> <span class="n">_s</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sval</span> <span class="o">=</span> <span class="n">_s</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">max_len</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sval</span><span class="p">[:</span> <span class="n">max_len</span> <span class="ow">or</span> <span class="mi">255</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="c1"># Type-driven coercion</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_datetime</span> <span class="k">as</span> <span class="n">_to_datetime</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_numeric</span> <span class="k">as</span> <span class="n">_to_numeric</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Date</span><span class="p">):</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="n">_to_datetime</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">else</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                    <span class="n">ts</span> <span class="o">=</span> <span class="n">_to_datetime</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
                        <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">py</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                        <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">)):</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="n">_to_numeric</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">):</span>
                    <span class="n">num</span> <span class="o">=</span> <span class="n">_to_numeric</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="k">else</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">sval</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_s</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>

                            <span class="n">sval</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="n">sval</span> <span class="o">=</span> <span class="n">_s</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sval</span> <span class="o">=</span> <span class="n">_s</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sval</span><span class="p">[:</span> <span class="n">max_len</span> <span class="ow">or</span> <span class="mi">255</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Leave other types as-is</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Last resort, stringify</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">_s</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">max_len</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span> <span class="n">max_len</span> <span class="ow">or</span> <span class="mi">255</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">rec</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">rec</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_list_tables_with_person_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">:</span> <span class="n">AsyncConnection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return table names (in default schema) that contain a person_id column, excluding &#39;person&#39;.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_inner</span><span class="p">(</span><span class="n">sync_conn</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span> <span class="k">as</span> <span class="n">_inspect</span>

            <span class="n">insp</span> <span class="o">=</span> <span class="n">_inspect</span><span class="p">(</span><span class="n">sync_conn</span><span class="p">)</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">insp</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
            <span class="n">result</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cols</span> <span class="o">=</span> <span class="n">insp</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;person_id&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">!=</span> <span class="s2">&quot;person&quot;</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">_inner</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_add_person_id_text_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a temporary person_id_text TEXT column to all non-person tables that have person_id.</span>

<span class="sd">        This avoids fragile type-alter and FK juggling. We&#39;ll populate this column</span>
<span class="sd">        when incoming person identifiers are not numeric, then resolve to integer</span>
<span class="sd">        person_id in step 2 and drop the column.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_tables_with_person_id</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dialect</span> <span class="o">==</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">:</span>
                <span class="n">ddl</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ALTER TABLE &quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&quot; ADD COLUMN IF NOT EXISTS person_id_text TEXT&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># SQLite (and others): try without IF NOT EXISTS</span>
                <span class="n">ddl</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ALTER TABLE &quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&quot; ADD COLUMN person_id_text TEXT&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">ddl</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Column may already exist or backend may not support IF NOT EXISTS; ignore</span>
                <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_drop_person_id_text_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop the temporary person_id_text column from all non-person tables.&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
        <span class="n">tables</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_tables_with_person_id</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dialect</span> <span class="o">==</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">:</span>
                <span class="n">ddl</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ALTER TABLE &quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&quot; DROP COLUMN IF EXISTS person_id_text&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ddl</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;ALTER TABLE &quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">&quot; DROP COLUMN person_id_text&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">ddl</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Some backends or versions (older SQLite) may not support DROP COLUMN; ignore</span>
                <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_load_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapping_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a JSON mapping file from disk.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mapping_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">filters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply optional row filters to a DataFrame prior to mapping.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">flt</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">flt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;column&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;equals&quot;</span> <span class="ow">in</span> <span class="n">flt</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="n">flt</span><span class="p">[</span><span class="s2">&quot;equals&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">flt</span><span class="p">[</span><span class="s2">&quot;equals&quot;</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="s2">&quot;not_empty&quot;</span> <span class="ow">in</span> <span class="n">flt</span> <span class="ow">and</span> <span class="n">flt</span><span class="p">[</span><span class="s2">&quot;not_empty&quot;</span><span class="p">]:</span>
                <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sa_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Coerce a CSV value into an appropriate Python type for insert.</span>

<span class="sd">        The conversion is guided by the SQLAlchemy column type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sa_type</span><span class="p">,</span> <span class="n">Date</span><span class="p">):</span>
                <span class="c1"># Accept many input formats</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">else</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sa_type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                <span class="c1"># Normalize to UTC-naive for Postgres compatibility</span>
                <span class="n">ts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">ts</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="s2">&quot;tzinfo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">py</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">py</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sa_type</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">)):</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sa_type</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">Decimal</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="c1"># Trim string values to 50 characters before insert</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mapping_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a CSV into multiple OMOP tables based on a mapping file.</span>

<span class="sd">        Args:</span>
<span class="sd">            csv_path: Path to the input CSV file.</span>
<span class="sd">            mapping_path: Path to the JSON mapping file. Defaults to the</span>
<span class="sd">                package&#39;s ``mapping.default.json`` when not provided.</span>
<span class="sd">            chunk_size: Batch size for INSERT statements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If mapping path is None, load mapping.default.json from the current directory</span>
        <span class="c1"># Step 1: Load CSV and mapping</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading CSV data from </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapping_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mapping_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;mapping.default.json&quot;</span><span class="p">)</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_mapping</span><span class="p">(</span><span class="n">mapping_path</span><span class="p">)</span>
        <span class="c1"># Use low_memory=False to avoid DtypeWarning for mixed-type columns</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="c1"># Relax constraint enforcement during bulk load on Postgres</span>
            <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_pg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = replica&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
                <span class="c1"># Before reflecting, add a temporary person_id_text column to accept non-numeric IDs</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_person_id_text_columns</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                <span class="n">automap</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_automap</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tables&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">table_name</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># obtain mapped class</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">mapper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39; not found in database.&quot;</span><span class="p">)</span>

                    <span class="c1"># compute filtered dataframe</span>
                    <span class="n">df_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filters</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filters&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">df_tbl</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">col_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="p">{})</span>
                    <span class="c1"># Gather target SQLA column metadata</span>
                    <span class="n">sa_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
                    <span class="n">sa_col_objs</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

                    <span class="c1"># Build records</span>
                    <span class="n">records</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_tbl</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="n">rec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">col_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;const&quot;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s2">&quot;const&quot;</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># IMPORTANT: keep person_id raw for staging logic below</span>
                            <span class="k">if</span> <span class="n">target_col</span> <span class="o">!=</span> <span class="s2">&quot;person_id&quot;</span><span class="p">:</span>
                                <span class="c1"># Convert based on SA type if available</span>
                                <span class="n">sa_t</span> <span class="o">=</span> <span class="n">sa_cols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">sa_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_value</span><span class="p">(</span><span class="n">sa_t</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="n">rec</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                        <span class="c1"># If person_id exists in the record, route non-numeric values into person_id_text</span>
                        <span class="k">if</span> <span class="s2">&quot;person_id&quot;</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">:</span>
                            <span class="n">pid</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># If NOT NULL, use placeholder to avoid constraint errors</span>
                                <span class="n">col</span> <span class="o">=</span> <span class="n">sa_col_objs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
                                    <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">,</span> <span class="kc">True</span>
                                <span class="p">):</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                                <span class="k">pass</span>
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="c1"># If conversion unexpectedly fails, send to text column</span>
                                    <span class="k">if</span> <span class="s2">&quot;person_id_text&quot;</span> <span class="ow">in</span> <span class="n">sa_cols</span><span class="p">:</span>
                                        <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                                    <span class="c1"># Respect NOT NULL with placeholder when required</span>
                                    <span class="n">col</span> <span class="o">=</span> <span class="n">sa_col_objs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
                                        <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">,</span> <span class="kc">True</span>
                                    <span class="p">):</span>
                                        <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Non-numeric content: place into person_id_text if available</span>
                                <span class="k">if</span> <span class="s2">&quot;person_id_text&quot;</span> <span class="ow">in</span> <span class="n">sa_cols</span><span class="p">:</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                                <span class="c1"># Respect NOT NULL with placeholder when required</span>
                                <span class="n">col</span> <span class="o">=</span> <span class="n">sa_col_objs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
                                    <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">,</span> <span class="kc">True</span>
                                <span class="p">):</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="c1"># Finally coerce all fields to the table&#39;s schema (string lengths, forced TEXT, datetimes)</span>
                        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_record_to_table_types</span><span class="p">(</span>
                            <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span>
                            <span class="n">rec</span><span class="p">,</span>
                            <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;force_text_fields&quot;</span><span class="p">,</span> <span class="p">[])),</span>
                        <span class="p">)</span>
                        <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
                    <span class="c1"># Chunked insert</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
                        <span class="n">batch</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
                        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
                <span class="c1"># Step 1 complete: all data loaded into target tables</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data loaded into target tables (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
                <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Step 2: Normalize person_id FKs using person.person_id (not person_source_value)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalizing person_id foreign keys&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_person_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span>

                <span class="c1"># Drop the temporary person_id_text columns now that person_id has been normalized</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drop_person_id_text_columns</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Person_id foreign keys normalized (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
                <span class="p">)</span>
                <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Step 3: Backfill year/month/day of birth from birth_datetime where missing or zero</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backfilling person birth fields&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">backfill_person_birth_fields</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Person birth fields backfilled (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
                <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Step 4: Set gender_concept_id from gender_source_value using standard IDs</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting person.gender_concept_id from gender_source_value&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_person_gender_concept_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Person gender_concept_id set (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
                <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Step 5: Apply concept mappings defined in the JSON mapping</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying concept mappings&quot;</span><span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_concept_mappings</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Concept mappings applied (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>

                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = origin&quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fix_person_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update all tables so that person_id foreign keys store the canonical</span>
<span class="sd">        person.person_id (integer), replacing any rows where person_id currently</span>
<span class="sd">        contains the person_source_value (string/UUID).</span>

<span class="sd">        Approach:</span>
<span class="sd">        - Build a mapping from person_source_value -&gt; person_id from the person table.</span>
<span class="sd">        - For each table (except person) having a person_id column, run updates:</span>
<span class="sd">                    SET person_id = person.person_id WHERE CAST(person_id AS TEXT) = person_source_value.</span>
<span class="sd">                - This is safe for SQLite (used in examples). For stricter RDBMS, ensure types</span>
<span class="sd">                    are compatible or adjust as needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Resolve person table from automap</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">person_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># No person table; nothing to do</span>

        <span class="n">person_table</span> <span class="o">=</span> <span class="n">person_cls</span><span class="o">.</span><span class="n">__table__</span>

        <span class="c1"># Build mapping of person_source_value -&gt; person_id</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_source_value</span><span class="p">,</span> <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_source_value</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">psv_to_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">psv</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">psv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">psv_to_id</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">psv</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">psv_to_id</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Iterate all tables and update person_id where it matches a known person_source_value</span>
        <span class="c1"># Also handle rows that staged a non-numeric value in person_id_text.</span>
        <span class="c1"># Avoid metadata.sorted_tables to prevent SAWarning about unresolvable cycles in vocab tables.</span>
        <span class="k">for</span> <span class="n">tbl_name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">automap</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">tbl_name</span> <span class="o">==</span> <span class="n">person_table</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s2">&quot;person_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># If person_id_text exists, prefer it for matching</span>
            <span class="n">has_text</span> <span class="o">=</span> <span class="s2">&quot;person_id_text&quot;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span>

            <span class="c1"># Run per-psv updates; small and explicit for clarity</span>
            <span class="k">for</span> <span class="n">psv</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">psv_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">has_text</span><span class="p">:</span>
                    <span class="c1"># Match on person_id_text</span>
                    <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id_text</span> <span class="o">==</span> <span class="n">psv</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
                <span class="c1"># Also try matching where person_id was staged as string</span>
                <span class="n">stmt2</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">String</span><span class="p">())</span> <span class="o">==</span> <span class="n">psv</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt2</span><span class="p">)</span>

            <span class="c1"># Clear person_id_text after normalization when column exists</span>
            <span class="k">if</span> <span class="n">has_text</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id_text</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                        <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">person_id_text</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_person_gender_concept_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update person.gender_concept_id from person.gender_source_value using static mapping:</span>
<span class="sd">            - male (or &#39;m&#39;)   -&gt; 8507</span>
<span class="sd">            - female (or &#39;f&#39;) -&gt; 8532</span>
<span class="sd">            - anything else   -&gt; 0 (unknown)</span>

<span class="sd">        Only updates rows where the computed value differs from the current value</span>
<span class="sd">        or where gender_concept_id is NULL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">person_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">person_table</span> <span class="o">=</span> <span class="n">person_cls</span><span class="o">.</span><span class="n">__table__</span>

        <span class="c1"># Fetch rows to evaluate. We consider all rows with a non-null gender_source_value</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gender_source_value</span><span class="p">,</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gender_concept_id</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gender_source_value</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">map_gender</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="mi">8507</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;female&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">}:</span>
                <span class="k">return</span> <span class="mi">8532</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">gsrc</span><span class="p">,</span> <span class="n">gcid</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">map_gender</span><span class="p">(</span><span class="n">gsrc</span><span class="p">)</span>
            <span class="c1"># Skip if already correct</span>
            <span class="k">if</span> <span class="n">gcid</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">update</span><span class="p">(</span><span class="n">person_table</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
                <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">gender_concept_id</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">backfill_person_birth_fields</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            In the person table, replace 0 or NULL values in year_of_birth, month_of_birth,</span>
<span class="sd">            and day_of_birth with values derived from birth_datetime.</span>

<span class="sd">        This runs in Python for portability across backends.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Resolve person table from automap</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">person_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">person_table</span> <span class="o">=</span> <span class="n">person_cls</span><span class="o">.</span><span class="n">__table__</span>

        <span class="c1"># Fetch necessary columns</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">birth_datetime</span><span class="p">,</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">year_of_birth</span><span class="p">,</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">month_of_birth</span><span class="p">,</span>
                <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">day_of_birth</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">birth_datetime</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">birth_dt</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
            <span class="c1"># Parse birth_dt to a datetime if needed</span>
            <span class="n">bd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">birth_dt</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="c1"># Normalize timezone-aware to UTC-naive</span>
                <span class="k">if</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">bd</span> <span class="o">=</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bd</span> <span class="o">=</span> <span class="n">birth_dt</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">birth_dt</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                <span class="n">bd</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">birth_dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">birth_dt</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
                        <span class="n">bd</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">py</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                        <span class="n">bd</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">bd</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">bd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">new_y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">bd</span><span class="o">.</span><span class="n">year</span>
            <span class="n">new_m</span> <span class="o">=</span> <span class="n">m</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">bd</span><span class="o">.</span><span class="n">month</span>
            <span class="n">new_d</span> <span class="o">=</span> <span class="n">d</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">bd</span><span class="o">.</span><span class="n">day</span>

            <span class="c1"># Only update when something changes</span>
            <span class="k">if</span> <span class="n">new_y</span> <span class="o">!=</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">new_m</span> <span class="o">!=</span> <span class="n">m</span> <span class="ow">or</span> <span class="n">new_d</span> <span class="o">!=</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">update</span><span class="p">(</span><span class="n">person_table</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span>
                        <span class="n">year_of_birth</span><span class="o">=</span><span class="n">new_y</span><span class="p">,</span>
                        <span class="n">month_of_birth</span><span class="o">=</span><span class="n">new_m</span><span class="p">,</span>
                        <span class="n">day_of_birth</span><span class="o">=</span><span class="n">new_d</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply_concept_mappings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
        <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span><span class="p">,</span>
        <span class="n">mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Based on the &quot;concept&quot; key in the mapping JSON, populate target *_concept_id columns</span>
<span class="sd">            by looking up concept.concept_id using codes found in the specified source column.</span>

<span class="sd">            Rules:</span>
<span class="sd">        - If the source value is a comma-separated string, use only the first element for lookup.</span>
<span class="sd">        - Find by equality on concept.concept_code.</span>
<span class="sd">        - Update the target column with the matching concept.concept_id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mapping</span> <span class="ow">or</span> <span class="s2">&quot;concept&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Resolve concept table</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">concept_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;concept&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">concept_table</span> <span class="o">=</span> <span class="n">concept_cls</span><span class="o">.</span><span class="n">__table__</span>

        <span class="c1"># Simple in-memory code to cid mapping</span>
        <span class="n">code_to_cid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lookup_concept_id</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_to_cid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">code_to_cid</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">select</span><span class="p">(</span><span class="n">concept_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">concept_id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">concept_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">concept_code</span> <span class="o">==</span> <span class="n">code</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">code_to_cid</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">cid</span>
            <span class="k">return</span> <span class="n">cid</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concept&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">table_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mapper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c1"># Target table not found; skip</span>
                <span class="k">continue</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span>
            <span class="n">pk_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pk_cols</span><span class="p">:</span>
                <span class="c1"># Cannot safely update without a primary key</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mappings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">source_col</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
                <span class="n">target_col</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">source_col</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_col</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">source_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span> <span class="ow">or</span> <span class="n">target_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Fetch candidate rows: target is NULL or 0, and source is not NULL/empty</span>
                <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">select</span><span class="p">(</span>
                        <span class="o">*</span><span class="n">pk_cols</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">source_col</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;_src&quot;</span><span class="p">),</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;_tgt&quot;</span><span class="p">),</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">or_</span><span class="p">(</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                            <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">source_col</span><span class="p">]</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">rows</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                    <span class="c1"># row is a tuple: (*pk_vals, _src, _tgt)</span>
                    <span class="n">pk_vals</span> <span class="o">=</span> <span class="n">row</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">)]</span>
                    <span class="n">src_val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">)]</span>

                    <span class="c1"># Only care about non-empty strings; if comma-separated, take first element</span>
                    <span class="n">code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="c1"># Split on comma and strip whitespace</span>
                        <span class="n">first</span> <span class="o">=</span> <span class="n">src_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="n">first</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">src_val</span><span class="p">:</span>
                        <span class="c1"># If a list somehow made it into the DB, use first element&#39;s string</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Fallback to simple string conversion if it&#39;s a scalar</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_val</span><span class="p">)</span> <span class="k">if</span> <span class="n">src_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">cid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lookup_concept_id</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Build WHERE with PK columns</span>
                    <span class="n">where_clause</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span>
                        <span class="o">*</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">pk_col</span> <span class="o">==</span> <span class="n">pk_val</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">pk_col</span><span class="p">,</span> <span class="n">pk_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">,</span> <span class="n">pk_vals</span><span class="p">)</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

                    <span class="n">stmt</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">({</span><span class="n">target_col</span><span class="p">:</span> <span class="n">cid</span><span class="p">})</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="loader.CdmCsvLoader.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">cdm_engine_factory</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;cdm54&#39;</span><span class="p">)</span></code>

<a href="#loader.CdmCsvLoader.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create a loader bound to a specific database engine.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cdm_engine_factory</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An initialized <code>CdmEngineFactory</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OMOP CDM version label ("cdm54" or "cdm6").</p>
              </div>
            </td>
            <td>
                  <code>&#39;cdm54&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/loader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdm_engine_factory</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cdm54&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a loader bound to a specific database engine.</span>

<span class="sd">    Args:</span>
<span class="sd">        cdm_engine_factory: An initialized ``CdmEngineFactory``.</span>
<span class="sd">        version: OMOP CDM version label (&quot;cdm54&quot; or &quot;cdm6&quot;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_cdm</span> <span class="o">=</span> <span class="n">cdm_engine_factory</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">cdm_engine_factory</span><span class="o">.</span><span class="n">engine</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_maker</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="n">async_scoped_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maker</span><span class="p">,</span> <span class="n">scopefunc</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">version</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="loader.CdmCsvLoader.apply_concept_mappings" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_concept_mappings</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#loader.CdmCsvLoader.apply_concept_mappings" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <pre><code>Based on the "concept" key in the mapping JSON, populate target *_concept_id columns
by looking up concept.concept_id using codes found in the specified source column.

Rules:
</code></pre>
<ul>
<li>If the source value is a comma-separated string, use only the first element for lookup.</li>
<li>Find by equality on concept.concept_code.</li>
<li>Update the target column with the matching concept.concept_id.</li>
</ul>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/loader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply_concept_mappings</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span><span class="p">,</span>
    <span class="n">mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Based on the &quot;concept&quot; key in the mapping JSON, populate target *_concept_id columns</span>
<span class="sd">        by looking up concept.concept_id using codes found in the specified source column.</span>

<span class="sd">        Rules:</span>
<span class="sd">    - If the source value is a comma-separated string, use only the first element for lookup.</span>
<span class="sd">    - Find by equality on concept.concept_code.</span>
<span class="sd">    - Update the target column with the matching concept.concept_id.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mapping</span> <span class="ow">or</span> <span class="s2">&quot;concept&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Resolve concept table</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">concept_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;concept&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">concept_table</span> <span class="o">=</span> <span class="n">concept_cls</span><span class="o">.</span><span class="n">__table__</span>

    <span class="c1"># Simple in-memory code to cid mapping</span>
    <span class="n">code_to_cid</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lookup_concept_id</span><span class="p">(</span><span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">code_to_cid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">code_to_cid</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">concept_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">concept_id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">concept_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">concept_code</span> <span class="o">==</span> <span class="n">code</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">code_to_cid</span><span class="p">[</span><span class="n">code</span><span class="p">]</span> <span class="o">=</span> <span class="n">cid</span>
        <span class="k">return</span> <span class="n">cid</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concept&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">table_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># Target table not found; skip</span>
            <span class="k">continue</span>

        <span class="n">table</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span>
        <span class="n">pk_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pk_cols</span><span class="p">:</span>
            <span class="c1"># Cannot safely update without a primary key</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mappings&quot;</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">source_col</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
            <span class="n">target_col</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">source_col</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">target_col</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">source_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span> <span class="ow">or</span> <span class="n">target_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Fetch candidate rows: target is NULL or 0, and source is not NULL/empty</span>
            <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="n">select</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">pk_cols</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">source_col</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;_src&quot;</span><span class="p">),</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;_tgt&quot;</span><span class="p">),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">or_</span><span class="p">(</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">source_col</span><span class="p">]</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">rows</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="c1"># row is a tuple: (*pk_vals, _src, _tgt)</span>
                <span class="n">pk_vals</span> <span class="o">=</span> <span class="n">row</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">)]</span>
                <span class="n">src_val</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">)]</span>

                <span class="c1"># Only care about non-empty strings; if comma-separated, take first element</span>
                <span class="n">code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c1"># Split on comma and strip whitespace</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">src_val</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">first</span> <span class="k">if</span> <span class="n">first</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">src_val</span><span class="p">:</span>
                    <span class="c1"># If a list somehow made it into the DB, use first element&#39;s string</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_val</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback to simple string conversion if it&#39;s a scalar</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">src_val</span><span class="p">)</span> <span class="k">if</span> <span class="n">src_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">cid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">lookup_concept_id</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Build WHERE with PK columns</span>
                <span class="n">where_clause</span> <span class="o">=</span> <span class="n">and_</span><span class="p">(</span>
                    <span class="o">*</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">pk_col</span> <span class="o">==</span> <span class="n">pk_val</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">pk_col</span><span class="p">,</span> <span class="n">pk_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pk_cols</span><span class="p">,</span> <span class="n">pk_vals</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>

                <span class="n">stmt</span> <span class="o">=</span> <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">({</span><span class="n">target_col</span><span class="p">:</span> <span class="n">cid</span><span class="p">})</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="loader.CdmCsvLoader.backfill_person_birth_fields" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">backfill_person_birth_fields</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#loader.CdmCsvLoader.backfill_person_birth_fields" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <pre><code>In the person table, replace 0 or NULL values in year_of_birth, month_of_birth,
and day_of_birth with values derived from birth_datetime.
</code></pre>
<p>This runs in Python for portability across backends.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/loader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">backfill_person_birth_fields</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In the person table, replace 0 or NULL values in year_of_birth, month_of_birth,</span>
<span class="sd">        and day_of_birth with values derived from birth_datetime.</span>

<span class="sd">    This runs in Python for portability across backends.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Resolve person table from automap</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">person_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">person_table</span> <span class="o">=</span> <span class="n">person_cls</span><span class="o">.</span><span class="n">__table__</span>

    <span class="c1"># Fetch necessary columns</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">birth_datetime</span><span class="p">,</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">year_of_birth</span><span class="p">,</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">month_of_birth</span><span class="p">,</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">day_of_birth</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">birth_datetime</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">birth_dt</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="c1"># Parse birth_dt to a datetime if needed</span>
        <span class="n">bd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">birth_dt</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="c1"># Normalize timezone-aware to UTC-naive</span>
            <span class="k">if</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">bd</span> <span class="o">=</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bd</span> <span class="o">=</span> <span class="n">birth_dt</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">birth_dt</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
            <span class="n">bd</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="n">birth_dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">birth_dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">birth_dt</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
                    <span class="n">bd</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">py</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                    <span class="n">bd</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">bd</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">bd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">new_y</span> <span class="o">=</span> <span class="n">y</span> <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">bd</span><span class="o">.</span><span class="n">year</span>
        <span class="n">new_m</span> <span class="o">=</span> <span class="n">m</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">bd</span><span class="o">.</span><span class="n">month</span>
        <span class="n">new_d</span> <span class="o">=</span> <span class="n">d</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="n">bd</span><span class="o">.</span><span class="n">day</span>

        <span class="c1"># Only update when something changes</span>
        <span class="k">if</span> <span class="n">new_y</span> <span class="o">!=</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">new_m</span> <span class="o">!=</span> <span class="n">m</span> <span class="ow">or</span> <span class="n">new_d</span> <span class="o">!=</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">update</span><span class="p">(</span><span class="n">person_table</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
                <span class="o">.</span><span class="n">values</span><span class="p">(</span>
                    <span class="n">year_of_birth</span><span class="o">=</span><span class="n">new_y</span><span class="p">,</span>
                    <span class="n">month_of_birth</span><span class="o">=</span><span class="n">new_m</span><span class="p">,</span>
                    <span class="n">day_of_birth</span><span class="o">=</span><span class="n">new_d</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="loader.CdmCsvLoader.fix_person_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fix_person_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#loader.CdmCsvLoader.fix_person_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Update all tables so that person_id foreign keys store the canonical
person.person_id (integer), replacing any rows where person_id currently
contains the person_source_value (string/UUID).</p>
<p>Approach:
- Build a mapping from person_source_value -&gt; person_id from the person table.
- For each table (except person) having a person_id column, run updates:
            SET person_id = person.person_id WHERE CAST(person_id AS TEXT) = person_source_value.
        - This is safe for SQLite (used in examples). For stricter RDBMS, ensure types
            are compatible or adjust as needed.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/loader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fix_person_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update all tables so that person_id foreign keys store the canonical</span>
<span class="sd">    person.person_id (integer), replacing any rows where person_id currently</span>
<span class="sd">    contains the person_source_value (string/UUID).</span>

<span class="sd">    Approach:</span>
<span class="sd">    - Build a mapping from person_source_value -&gt; person_id from the person table.</span>
<span class="sd">    - For each table (except person) having a person_id column, run updates:</span>
<span class="sd">                SET person_id = person.person_id WHERE CAST(person_id AS TEXT) = person_source_value.</span>
<span class="sd">            - This is safe for SQLite (used in examples). For stricter RDBMS, ensure types</span>
<span class="sd">                are compatible or adjust as needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Resolve person table from automap</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">person_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span>  <span class="c1"># No person table; nothing to do</span>

    <span class="n">person_table</span> <span class="o">=</span> <span class="n">person_cls</span><span class="o">.</span><span class="n">__table__</span>

    <span class="c1"># Build mapping of person_source_value -&gt; person_id</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_source_value</span><span class="p">,</span> <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_source_value</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">psv_to_id</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">psv</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">psv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">psv_to_id</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">psv</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">psv_to_id</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Iterate all tables and update person_id where it matches a known person_source_value</span>
    <span class="c1"># Also handle rows that staged a non-numeric value in person_id_text.</span>
    <span class="c1"># Avoid metadata.sorted_tables to prevent SAWarning about unresolvable cycles in vocab tables.</span>
    <span class="k">for</span> <span class="n">tbl_name</span><span class="p">,</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">automap</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tbl_name</span> <span class="o">==</span> <span class="n">person_table</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="s2">&quot;person_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># If person_id_text exists, prefer it for matching</span>
        <span class="n">has_text</span> <span class="o">=</span> <span class="s2">&quot;person_id_text&quot;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span>

        <span class="c1"># Run per-psv updates; small and explicit for clarity</span>
        <span class="k">for</span> <span class="n">psv</span><span class="p">,</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">psv_to_id</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">has_text</span><span class="p">:</span>
                <span class="c1"># Match on person_id_text</span>
                <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id_text</span> <span class="o">==</span> <span class="n">psv</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
            <span class="c1"># Also try matching where person_id was staged as string</span>
            <span class="n">stmt2</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cast</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span> <span class="n">String</span><span class="p">())</span> <span class="o">==</span> <span class="n">psv</span><span class="p">)</span>
                <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">person_id</span><span class="o">=</span><span class="n">pid</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt2</span><span class="p">)</span>

        <span class="c1"># Clear person_id_text after normalization when column exists</span>
        <span class="k">if</span> <span class="n">has_text</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">update</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id_text</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
                    <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">person_id_text</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="loader.CdmCsvLoader.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">mapping_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#loader.CdmCsvLoader.load" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load a CSV into multiple OMOP tables based on a mapping file.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>csv_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the input CSV file.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mapping_path</code>
            </td>
            <td>
                  <code><span title="str">str</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the JSON mapping file. Defaults to the
package's <code>mapping.default.json</code> when not provided.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_size</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Batch size for INSERT statements.</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/loader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mapping_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a CSV into multiple OMOP tables based on a mapping file.</span>

<span class="sd">    Args:</span>
<span class="sd">        csv_path: Path to the input CSV file.</span>
<span class="sd">        mapping_path: Path to the JSON mapping file. Defaults to the</span>
<span class="sd">            package&#39;s ``mapping.default.json`` when not provided.</span>
<span class="sd">        chunk_size: Batch size for INSERT statements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If mapping path is None, load mapping.default.json from the current directory</span>
    <span class="c1"># Step 1: Load CSV and mapping</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading CSV data from </span><span class="si">{</span><span class="n">csv_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mapping_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mapping_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;mapping.default.json&quot;</span><span class="p">)</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_mapping</span><span class="p">(</span><span class="n">mapping_path</span><span class="p">)</span>
    <span class="c1"># Use low_memory=False to avoid DtypeWarning for mixed-type columns</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_path</span><span class="p">,</span> <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># Relax constraint enforcement during bulk load on Postgres</span>
        <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_pg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = replica&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
            <span class="c1"># Before reflecting, add a temporary person_id_text column to accept non-numeric IDs</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_person_id_text_columns</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">automap</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_automap</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tables&quot;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">table_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># obtain mapped class</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mapper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Table &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39; not found in database.&quot;</span><span class="p">)</span>

                <span class="c1"># compute filtered dataframe</span>
                <span class="n">df_tbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_filters</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filters&quot;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">df_tbl</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">col_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="c1"># Gather target SQLA column metadata</span>
                <span class="n">sa_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">type</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
                <span class="n">sa_col_objs</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

                <span class="c1"># Build records</span>
                <span class="n">records</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_tbl</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">rec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">target_col</span><span class="p">,</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">col_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;const&quot;</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="s2">&quot;const&quot;</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>

                        <span class="c1"># IMPORTANT: keep person_id raw for staging logic below</span>
                        <span class="k">if</span> <span class="n">target_col</span> <span class="o">!=</span> <span class="s2">&quot;person_id&quot;</span><span class="p">:</span>
                            <span class="c1"># Convert based on SA type if available</span>
                            <span class="n">sa_t</span> <span class="o">=</span> <span class="n">sa_cols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_col</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">sa_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_value</span><span class="p">(</span><span class="n">sa_t</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">rec</span><span class="p">[</span><span class="n">target_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="c1"># If person_id exists in the record, route non-numeric values into person_id_text</span>
                    <span class="k">if</span> <span class="s2">&quot;person_id&quot;</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">:</span>
                        <span class="n">pid</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># If NOT NULL, use placeholder to avoid constraint errors</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="n">sa_col_objs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
                                <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">,</span> <span class="kc">True</span>
                            <span class="p">):</span>
                                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                            <span class="k">pass</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pid</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pid</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="c1"># If conversion unexpectedly fails, send to text column</span>
                                <span class="k">if</span> <span class="s2">&quot;person_id_text&quot;</span> <span class="ow">in</span> <span class="n">sa_cols</span><span class="p">:</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                                <span class="c1"># Respect NOT NULL with placeholder when required</span>
                                <span class="n">col</span> <span class="o">=</span> <span class="n">sa_col_objs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
                                    <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">,</span> <span class="kc">True</span>
                                <span class="p">):</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Non-numeric content: place into person_id_text if available</span>
                            <span class="k">if</span> <span class="s2">&quot;person_id_text&quot;</span> <span class="ow">in</span> <span class="n">sa_cols</span><span class="p">:</span>
                                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id_text&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
                            <span class="c1"># Respect NOT NULL with placeholder when required</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="n">sa_col_objs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;person_id&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span>
                                <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;nullable&quot;</span><span class="p">,</span> <span class="kc">True</span>
                            <span class="p">):</span>
                                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">rec</span><span class="p">[</span><span class="s2">&quot;person_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># Finally coerce all fields to the table&#39;s schema (string lengths, forced TEXT, datetimes)</span>
                    <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coerce_record_to_table_types</span><span class="p">(</span>
                        <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span>
                        <span class="n">rec</span><span class="p">,</span>
                        <span class="nb">set</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;force_text_fields&quot;</span><span class="p">,</span> <span class="p">[])),</span>
                    <span class="p">)</span>
                    <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>
                <span class="c1"># Chunked insert</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">records</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
                    <span class="n">batch</span> <span class="o">=</span> <span class="n">records</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="c1"># Step 1 complete: all data loaded into target tables</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data loaded into target tables (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
            <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Step 2: Normalize person_id FKs using person.person_id (not person_source_value)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Normalizing person_id foreign keys&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_person_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span>

            <span class="c1"># Drop the temporary person_id_text columns now that person_id has been normalized</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drop_person_id_text_columns</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Person_id foreign keys normalized (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span>
            <span class="p">)</span>
            <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Step 3: Backfill year/month/day of birth from birth_datetime where missing or zero</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Backfilling person birth fields&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">backfill_person_birth_fields</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Person birth fields backfilled (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
            <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Step 4: Set gender_concept_id from gender_source_value using standard IDs</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting person.gender_concept_id from gender_source_value&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_person_gender_concept_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Person gender_concept_id set (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
            <span class="n">step_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="c1"># Step 5: Apply concept mappings defined in the JSON mapping</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying concept mappings&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_concept_mappings</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">step_time</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Concept mappings applied (elapsed: </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = origin&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="loader.CdmCsvLoader.update_person_gender_concept_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update_person_gender_concept_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">automap</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#loader.CdmCsvLoader.update_person_gender_concept_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <pre><code>Update person.gender_concept_id from person.gender_source_value using static mapping:
- male (or 'm')   -&gt; 8507
- female (or 'f') -&gt; 8532
- anything else   -&gt; 0 (unknown)
</code></pre>
<p>Only updates rows where the computed value differs from the current value
or where gender_concept_id is NULL.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/loader.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_person_gender_concept_id</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update person.gender_concept_id from person.gender_source_value using static mapping:</span>
<span class="sd">        - male (or &#39;m&#39;)   -&gt; 8507</span>
<span class="sd">        - female (or &#39;f&#39;) -&gt; 8532</span>
<span class="sd">        - anything else   -&gt; 0 (unknown)</span>

<span class="sd">    Only updates rows where the computed value differs from the current value</span>
<span class="sd">    or where gender_concept_id is NULL.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">person_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="s2">&quot;person&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">person_table</span> <span class="o">=</span> <span class="n">person_cls</span><span class="o">.</span><span class="n">__table__</span>

    <span class="c1"># Fetch rows to evaluate. We consider all rows with a non-null gender_source_value</span>
    <span class="n">res</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span><span class="p">,</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gender_source_value</span><span class="p">,</span>
            <span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gender_concept_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">gender_source_value</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">map_gender</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;male&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="mi">8507</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">{</span><span class="s2">&quot;female&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">}:</span>
            <span class="k">return</span> <span class="mi">8532</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">gsrc</span><span class="p">,</span> <span class="n">gcid</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">map_gender</span><span class="p">(</span><span class="n">gsrc</span><span class="p">)</span>
        <span class="c1"># Skip if already correct</span>
        <span class="k">if</span> <span class="n">gcid</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">update</span><span class="p">(</span><span class="n">person_table</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">person_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">person_id</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">gender_concept_id</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="main"></a>
    <div class="doc doc-contents first">

        <p>Command-line interface for pyomop.</p>
<p>Provides commands to create CDM tables, load vocabulary CSVs, and import FHIR
Bulk Export data into an OMOP database.</p>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="main.main_routine" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">main_routine</span><span class="p">()</span></code>

<a href="#main.main_routine" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Top-level runner used by <code>python -m pyomop</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/main.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main_routine</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Top-level runner used by ``python -m pyomop``.&quot;&quot;&quot;</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;_________________________________________&quot;</span><span class="p">)</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Pyomop v&quot;</span> <span class="o">+</span> <span class="n">__version__</span> <span class="o">+</span> <span class="s2">&quot; by Bell Eapen ( https://nuchange.ca ) &quot;</span><span class="p">)</span>
    <span class="n">cli</span><span class="p">()</span>  <span class="c1"># run the main function</span>
    <span class="n">click</span><span class="o">.</span><span class="n">echo</span><span class="p">(</span><span class="s2">&quot;Pyomop done.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="vocabulary"></a>
    <div class="doc doc-contents first">

        <p>Vocabulary utilities for loading and querying OMOP vocab tables.</p>
<p>Provides helpers to import vocabulary CSVs into the database and to look up
concepts by id or code. Uses async SQLAlchemy sessions.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="vocabulary.CdmVocabulary" class="doc doc-heading">
            <code>CdmVocabulary</code>


<a href="#vocabulary.CdmVocabulary" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="object">object</span></code></p>



        <p>Helpers for OMOP Vocabulary management and lookups.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cdm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An initialized <code>CdmEngineFactory</code> instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>version</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CDM version string ("cdm54" or "cdm6"). Defaults to "cdm54".</p>
              </div>
            </td>
            <td>
                  <code>&#39;cdm54&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/vocabulary.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CdmVocabulary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helpers for OMOP Vocabulary management and lookups.</span>

<span class="sd">    Args:</span>
<span class="sd">        cdm: An initialized ``CdmEngineFactory`` instance.</span>
<span class="sd">        version: CDM version string (&quot;cdm54&quot; or &quot;cdm6&quot;). Defaults to &quot;cdm54&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdm</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s2">&quot;cdm54&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_class_id</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_code</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cdm</span> <span class="o">=</span> <span class="n">cdm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">cdm</span><span class="o">.</span><span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_maker</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span> <span class="o">=</span> <span class="n">async_scoped_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_maker</span><span class="p">,</span> <span class="n">scopefunc</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">=</span> <span class="n">version</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">concept_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current concept_id for this helper (if set).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concept_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">concept_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current concept_code for this helper (if set).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concept_code</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">concept_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current concept_name for this helper (if set).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_concept_name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">vocabulary_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current vocabulary_id for this helper (if set).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">domain_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Current domain_id for this helper (if set).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_domain_id</span>

    <span class="nd">@concept_id</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">concept_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the active concept context by concept_id.</span>

<span class="sd">        Side effects: populates concept name, domain, vocabulary, class, and code</span>
<span class="sd">        on this helper instance for convenience.</span>

<span class="sd">        Args:</span>
<span class="sd">            concept_id: The concept_id to fetch and set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_id</span> <span class="o">=</span> <span class="n">concept_id</span>
        <span class="n">_concept</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_concept</span><span class="p">(</span><span class="n">concept_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_name</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">domain_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">vocabulary_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_class_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_class_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_code</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_code</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch a concept row by id.</span>

<span class="sd">        Args:</span>
<span class="sd">            concept_id: Concept identifier.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The ORM Concept instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">==</span> <span class="s2">&quot;cdm6&quot;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm6</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm54</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Concept</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Concept</span><span class="o">.</span><span class="n">concept_id</span> <span class="o">==</span> <span class="n">concept_id</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cdm</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">_concept</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_concept</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_concept_by_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch a concept by code within a vocabulary.</span>

<span class="sd">        Args:</span>
<span class="sd">            concept_code: The vocabulary-specific code string.</span>
<span class="sd">            vocabulary_id: Vocabulary identifier (e.g., &#39;SNOMED&#39;, &#39;LOINC&#39;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The ORM Concept instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">==</span> <span class="s2">&quot;cdm6&quot;</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm6</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm54</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">Concept</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Concept</span><span class="o">.</span><span class="n">concept_code</span> <span class="o">==</span> <span class="n">concept_code</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Concept</span><span class="o">.</span><span class="n">vocabulary_id</span> <span class="o">==</span> <span class="n">vocabulary_id</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cdm</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">_concept</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_concept</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the active concept context by code and vocabulary.</span>

<span class="sd">        Args:</span>
<span class="sd">            concept_code: The concept code string to resolve.</span>
<span class="sd">            vocabulary_id: Vocabulary identifier. Required.</span>

<span class="sd">        Notes:</span>
<span class="sd">            On success, populates concept fields on this instance. On failure,</span>
<span class="sd">            sets ``_vocabulary_id`` and ``_concept_id`` to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_code</span> <span class="o">=</span> <span class="n">concept_code</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">vocabulary_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_id</span> <span class="o">=</span> <span class="n">vocabulary_id</span>
                <span class="n">_concept</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_concept_by_code</span><span class="p">(</span><span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;vocabulary_id must be provided when setting concept by code.&quot;</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_concept_name</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_domain_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">domain_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concept_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concept_class_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_class_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concept_code</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_code</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_concept_id</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load vocabulary CSV files from a folder into the database.</span>

<span class="sd">        This imports the standard OMOP vocab tables (drug_strength, concept,</span>
<span class="sd">        concept_relationship, concept_ancestor, concept_synonym, vocabulary,</span>
<span class="sd">        relationship, concept_class, domain).</span>

<span class="sd">        Args:</span>
<span class="sd">            folder: Path to the folder containing OMOP vocabulary CSVs.</span>
<span class="sd">            sample: Optional number of rows to limit per file during import.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Parents first (for concept FKs): DOMAIN, CONCEPT_CLASS</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/DOMAIN.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;domain&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DOMAIN.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_CLASS.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_class&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_CLASS.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="c1"># Then CONCEPT (uses domain_id and concept_class_id)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="c1"># Then VOCABULARY (uses vocabulary_concept_id -&gt; concept)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/VOCABULARY.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;vocabulary&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VOCABULARY.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="c1"># Relationship depends on concept for relationship_concept_id</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/RELATIONSHIP.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;relationship&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RELATIONSHIP.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="c1"># Post-concept tables</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_RELATIONSHIP.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_relationship&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_RELATIONSHIP.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_SYNONYM.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_synonym&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_SYNONYM.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/DRUG_STRENGTH.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
            <span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;drug_strength&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DRUG_STRENGTH.csv loaded and processed.&quot;</span><span class="p">)</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_ANCESTOR.csv&quot;</span><span class="p">,</span>
                <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_ancestor&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_ANCESTOR.csv loaded and processed.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while creating the vocabulary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield an async session bound to the current engine.</span>

<span class="sd">        Yields:</span>
<span class="sd">            AsyncSession: An async SQLAlchemy session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">write_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Write a DataFrame to a vocabulary table with type-safe defaults.</span>

<span class="sd">        Ensures required columns exist with reasonable defaults, coerces types,</span>
<span class="sd">        and performs chunked inserts via SQLAlchemy core for performance.</span>

<span class="sd">        Args:</span>
<span class="sd">            df: Pandas DataFrame with data to insert.</span>
<span class="sd">            table: Target table name (e.g., &#39;concept&#39;).</span>
<span class="sd">            if_exists: Compatibility only. This method always inserts.</span>
<span class="sd">            chunk_size: Number of rows per batch insert.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="c1"># For PostgreSQL, temporarily relax constraint enforcement during bulk loads</span>
            <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">is_pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;Temporarily disabling replication role for bulk load on postgres&quot;</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = replica&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Ignore if not permitted or unsupported</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to set session_replication_role to replica&quot;</span><span class="p">)</span>

            <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
            <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">prepare_automap</span><span class="p">(</span><span class="n">sync_conn</span><span class="p">):</span>
                <span class="n">automap</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">autoload_with</span><span class="o">=</span><span class="n">sync_conn</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">prepare_automap</span><span class="p">)</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

            <span class="c1"># Build defaults for non-nullable columns based on SQL types</span>
            <span class="n">sa_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                    <span class="n">BigInteger</span><span class="p">,</span>
                    <span class="n">Date</span><span class="p">,</span>
                    <span class="n">DateTime</span><span class="p">,</span>
                    <span class="n">Integer</span><span class="p">,</span>
                    <span class="n">Numeric</span><span class="p">,</span>
                    <span class="n">String</span><span class="p">,</span>
                    <span class="n">Text</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">t</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">type</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">):</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="s2">&quot;UNKNOWN&quot;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Date</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Work on a copy so we can normalize types and fill required fields</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sa_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Ensure column exists</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="c1"># For nullable columns, start with None; for required, use default</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># Coerce types and handle missing values</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                    <span class="c1"># Treat empty strings as missing</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

                <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BigInteger</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Date</span> <span class="k">as</span> <span class="n">SA_Date</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">DateTime</span> <span class="k">as</span> <span class="n">SA_DateTime</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Text</span>

                <span class="n">t</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">type</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">SA_Date</span><span class="p">):</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                        <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">SA_DateTime</span><span class="p">):</span>
                    <span class="c1"># Normalize to UTC-naive to avoid tz-aware vs tz-naive issues in Postgres</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="c1"># Convert to Python datetime and drop tzinfo</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">_to_naive</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
                                <span class="k">return</span> <span class="kc">None</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;to_pydatetime&quot;</span><span class="p">):</span>
                            <span class="n">py</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">py</span> <span class="o">=</span> <span class="n">dt</span>
                        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="s2">&quot;tzinfo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">py</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">py</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="s2">&quot;tz_convert&quot;</span><span class="p">)</span>
                                <span class="k">else</span> <span class="n">py</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">return</span> <span class="n">py</span>

                    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_to_naive</span><span class="p">)</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                        <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">)):</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                        <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">):</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                        <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                    <span class="c1"># Only cast non-null values to str and trim; keep nulls as None</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                    <span class="n">ser</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                        <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Required string columns get a default</span>
                        <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Fallback: ensure NaN/NaT -&gt; None for nullable cols, else fill default</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                        <span class="k">else</span> <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                    <span class="p">)</span>

            <span class="c1"># Final safety pass: replace any remaining NaN/NaT with None across all columns</span>
            <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">df2</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">//</span> <span class="n">chunk_size</span>
                <span class="p">):</span>
                    <span class="n">records</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Fast path: batch insert</span>
                        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Batch insert failed, falling back to row-by-row insert.&quot;</span>
                        <span class="p">)</span>
                        <span class="c1"># Fallback: insert row-by-row, skipping bad rows</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="c1"># Ignore duplicates/FK issues per row</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                    <span class="sa">f</span><span class="s2">&quot;Failed to insert row: </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span>
                                <span class="p">)</span>
                                <span class="k">continue</span>
                    <span class="c1"># Commit after each group</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                            <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = origin&quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="vocabulary.CdmVocabulary.concept_code" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">concept_code</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.concept_code" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Current concept_code for this helper (if set).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="vocabulary.CdmVocabulary.concept_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">concept_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.concept_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Current concept_id for this helper (if set).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="vocabulary.CdmVocabulary.concept_name" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">concept_name</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.concept_name" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Current concept_name for this helper (if set).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="vocabulary.CdmVocabulary.domain_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">domain_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.domain_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Current domain_id for this helper (if set).</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="vocabulary.CdmVocabulary.vocabulary_id" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">vocabulary_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.vocabulary_id" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Current vocabulary_id for this helper (if set).</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="vocabulary.CdmVocabulary.create_vocab" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_vocab</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.create_vocab" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Load vocabulary CSV files from a folder into the database.</p>
<p>This imports the standard OMOP vocab tables (drug_strength, concept,
concept_relationship, concept_ancestor, concept_synonym, vocabulary,
relationship, concept_class, domain).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>folder</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the folder containing OMOP vocabulary CSVs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional number of rows to limit per file during import.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vocabulary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load vocabulary CSV files from a folder into the database.</span>

<span class="sd">    This imports the standard OMOP vocab tables (drug_strength, concept,</span>
<span class="sd">    concept_relationship, concept_ancestor, concept_synonym, vocabulary,</span>
<span class="sd">    relationship, concept_class, domain).</span>

<span class="sd">    Args:</span>
<span class="sd">        folder: Path to the folder containing OMOP vocabulary CSVs.</span>
<span class="sd">        sample: Optional number of rows to limit per file during import.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parents first (for concept FKs): DOMAIN, CONCEPT_CLASS</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/DOMAIN.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;domain&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DOMAIN.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_CLASS.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_class&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_CLASS.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="c1"># Then CONCEPT (uses domain_id and concept_class_id)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="c1"># Then VOCABULARY (uses vocabulary_concept_id -&gt; concept)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/VOCABULARY.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;vocabulary&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;VOCABULARY.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="c1"># Relationship depends on concept for relationship_concept_id</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/RELATIONSHIP.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;relationship&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;RELATIONSHIP.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="c1"># Post-concept tables</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_RELATIONSHIP.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_relationship&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_RELATIONSHIP.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_SYNONYM.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_synonym&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_SYNONYM.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/DRUG_STRENGTH.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_start_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;valid_end_date&quot;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;drug_strength&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DRUG_STRENGTH.csv loaded and processed.&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;/CONCEPT_ANCESTOR.csv&quot;</span><span class="p">,</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">sample</span><span class="p">,</span>
            <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
            <span class="n">low_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;concept_ancestor&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CONCEPT_ANCESTOR.csv loaded and processed.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred while creating the vocabulary: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vocabulary.CdmVocabulary.get_concept" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_concept</span><span class="p">(</span><span class="n">concept_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.get_concept" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Fetch a concept row by id.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>concept_id</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Concept identifier.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ORM Concept instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vocabulary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch a concept row by id.</span>

<span class="sd">    Args:</span>
<span class="sd">        concept_id: Concept identifier.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The ORM Concept instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">==</span> <span class="s2">&quot;cdm6&quot;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm6</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm54</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">Concept</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Concept</span><span class="o">.</span><span class="n">concept_id</span> <span class="o">==</span> <span class="n">concept_id</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cdm</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">_concept</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_concept</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vocabulary.CdmVocabulary.get_concept_by_code" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_concept_by_code</span><span class="p">(</span><span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.get_concept_by_code" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Fetch a concept by code within a vocabulary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>concept_code</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The vocabulary-specific code string.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vocabulary_id</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vocabulary identifier (e.g., 'SNOMED', 'LOINC').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ORM Concept instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vocabulary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_concept_by_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch a concept by code within a vocabulary.</span>

<span class="sd">    Args:</span>
<span class="sd">        concept_code: The vocabulary-specific code string.</span>
<span class="sd">        vocabulary_id: Vocabulary identifier (e.g., &#39;SNOMED&#39;, &#39;LOINC&#39;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The ORM Concept instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_version</span> <span class="o">==</span> <span class="s2">&quot;cdm6&quot;</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm6</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">.cdm54</span><span class="w"> </span><span class="kn">import</span> <span class="n">Concept</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">Concept</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Concept</span><span class="o">.</span><span class="n">concept_code</span> <span class="o">==</span> <span class="n">concept_code</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Concept</span><span class="o">.</span><span class="n">vocabulary_id</span> <span class="o">==</span> <span class="n">vocabulary_id</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cdm</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">_concept</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_concept</span><span class="o">.</span><span class="n">scalar_one</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vocabulary.CdmVocabulary.get_session" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_session</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.get_session" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Yield an async session bound to the current engine.</p>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>AsyncSession</code></td>            <td>
                  <code><span title="typing.AsyncGenerator">AsyncGenerator</span>[<span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span>, None]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An async SQLAlchemy session.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vocabulary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield an async session bound to the current engine.</span>

<span class="sd">    Yields:</span>
<span class="sd">        AsyncSession: An async SQLAlchemy session.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scope</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">session</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vocabulary.CdmVocabulary.set_concept" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_concept</span><span class="p">(</span><span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#vocabulary.CdmVocabulary.set_concept" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Set the active concept context by code and vocabulary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>concept_code</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The concept code string to resolve.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>vocabulary_id</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Vocabulary identifier. Required.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="notes" open>
  <summary>Notes</summary>
  <p>On success, populates concept fields on this instance. On failure,
sets <code>_vocabulary_id</code> and <code>_concept_id</code> to 0.</p>
</details>

            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vocabulary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_concept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the active concept context by code and vocabulary.</span>

<span class="sd">    Args:</span>
<span class="sd">        concept_code: The concept code string to resolve.</span>
<span class="sd">        vocabulary_id: Vocabulary identifier. Required.</span>

<span class="sd">    Notes:</span>
<span class="sd">        On success, populates concept fields on this instance. On failure,</span>
<span class="sd">        sets ``_vocabulary_id`` and ``_concept_id`` to 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_concept_code</span> <span class="o">=</span> <span class="n">concept_code</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vocabulary_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_id</span> <span class="o">=</span> <span class="n">vocabulary_id</span>
            <span class="n">_concept</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_concept_by_code</span><span class="p">(</span><span class="n">concept_code</span><span class="p">,</span> <span class="n">vocabulary_id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;vocabulary_id must be provided when setting concept by code.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_name</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_domain_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">domain_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_class_id</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_class_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_code</span> <span class="o">=</span> <span class="n">_concept</span><span class="o">.</span><span class="n">concept_code</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vocabulary_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_concept_id</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vocabulary.CdmVocabulary.write_vocab" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_vocab</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#vocabulary.CdmVocabulary.write_vocab" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Write a DataFrame to a vocabulary table with type-safe defaults.</p>
<p>Ensures required columns exist with reasonable defaults, coerces types,
and performs chunked inserts via SQLAlchemy core for performance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>df</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pandas DataFrame with data to insert.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>table</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Target table name (e.g., 'concept').</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>if_exists</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Compatibility only. This method always inserts.</p>
              </div>
            </td>
            <td>
                  <code>&#39;replace&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chunk_size</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of rows per batch insert.</p>
              </div>
            </td>
            <td>
                  <code>1000</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vocabulary.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">write_vocab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a DataFrame to a vocabulary table with type-safe defaults.</span>

<span class="sd">    Ensures required columns exist with reasonable defaults, coerces types,</span>
<span class="sd">    and performs chunked inserts via SQLAlchemy core for performance.</span>

<span class="sd">    Args:</span>
<span class="sd">        df: Pandas DataFrame with data to insert.</span>
<span class="sd">        table: Target table name (e.g., &#39;concept&#39;).</span>
<span class="sd">        if_exists: Compatibility only. This method always inserts.</span>
<span class="sd">        chunk_size: Number of rows per batch insert.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># For PostgreSQL, temporarily relax constraint enforcement during bulk loads</span>
        <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">is_pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;postgres&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">is_pg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Temporarily disabling replication role for bulk load on postgres&quot;</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                    <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = replica&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Ignore if not permitted or unsupported</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to set session_replication_role to replica&quot;</span><span class="p">)</span>

        <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span>
        <span class="n">automap</span><span class="p">:</span> <span class="n">AutomapBase</span> <span class="o">=</span> <span class="n">automap_base</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">prepare_automap</span><span class="p">(</span><span class="n">sync_conn</span><span class="p">):</span>
            <span class="n">automap</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">autoload_with</span><span class="o">=</span><span class="n">sync_conn</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">prepare_automap</span><span class="p">)</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">automap</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

        <span class="c1"># Build defaults for non-nullable columns based on SQL types</span>
        <span class="n">sa_cols</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
                <span class="n">BigInteger</span><span class="p">,</span>
                <span class="n">Date</span><span class="p">,</span>
                <span class="n">DateTime</span><span class="p">,</span>
                <span class="n">Integer</span><span class="p">,</span>
                <span class="n">Numeric</span><span class="p">,</span>
                <span class="n">String</span><span class="p">,</span>
                <span class="n">Text</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">)):</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">):</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                <span class="k">return</span> <span class="s2">&quot;UNKNOWN&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Date</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Work on a copy so we can normalize types and fill required fields</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sa_cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Ensure column exists</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># For nullable columns, start with None; for required, use default</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Coerce types and handle missing values</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
                <span class="c1"># Treat empty strings as missing</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BigInteger</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Date</span> <span class="k">as</span> <span class="n">SA_Date</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">DateTime</span> <span class="k">as</span> <span class="n">SA_DateTime</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Text</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">col</span><span class="o">.</span><span class="n">type</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">SA_Date</span><span class="p">):</span>
                <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                    <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">SA_DateTime</span><span class="p">):</span>
                <span class="c1"># Normalize to UTC-naive to avoid tz-aware vs tz-naive issues in Postgres</span>
                <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Convert to Python datetime and drop tzinfo</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">_to_naive</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
                            <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s2">&quot;to_pydatetime&quot;</span><span class="p">):</span>
                        <span class="n">py</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">py</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="s2">&quot;tzinfo&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">py</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">py</span><span class="o">.</span><span class="n">tz_convert</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="s2">&quot;tz_convert&quot;</span><span class="p">)</span>
                            <span class="k">else</span> <span class="n">py</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">return</span> <span class="n">py</span>

                <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_to_naive</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                    <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">)):</span>
                <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                    <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">):</span>
                <span class="n">ser</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                    <span class="k">else</span> <span class="n">ser</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                <span class="c1"># Only cast non-null values to str and trim; keep nulls as None</span>
                <span class="n">ser</span> <span class="o">=</span> <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">notna</span><span class="p">()</span>
                <span class="n">ser</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Required string columns get a default</span>
                    <span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">ser</span><span class="p">),</span> <span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ser</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback: ensure NaN/NaT -&gt; None for nullable cols, else fill default</span>
                <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">nullable</span>
                    <span class="k">else</span> <span class="n">df2</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">default_for</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
                <span class="p">)</span>

        <span class="c1"># Final safety pass: replace any remaining NaN/NaT with None across all columns</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">df2</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">mapper</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">//</span> <span class="n">chunk_size</span>
            <span class="p">):</span>
                <span class="n">records</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Fast path: batch insert</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Batch insert failed, falling back to row-by-row insert.&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Fallback: insert row-by-row, skipping bad rows</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="c1"># Ignore duplicates/FK issues per row</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Failed to insert row: </span><span class="si">{</span><span class="n">row</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span>
                            <span class="p">)</span>
                            <span class="k">continue</span>
                <span class="c1"># Commit after each group</span>
                <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_pg</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                        <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SET session_replication_role = origin&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="vector"></a>
    <div class="doc doc-contents first">

        <p>Utilities to execute queries and convert results to DataFrames.</p>
<p>Exposes a small helper class around async SQLAlchemy execution and integration
with OHDSI QueryLibrary.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="vector.CdmVector" class="doc doc-heading">
            <code>CdmVector</code>


<a href="#vector.CdmVector" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="object">object</span></code></p>



        <p>Query execution utility for OMOP CDM.</p>
<p>Methods let you run raw SQL or QueryLibrary snippets and turn results into
pandas DataFrames.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src/pyomop/vector.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CdmVector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Query execution utility for OMOP CDM.</span>

<span class="sd">    Methods let you run raw SQL or QueryLibrary snippets and turn results into</span>
<span class="sd">    pandas DataFrames.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdm</span><span class="p">,</span> <span class="n">sqldict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a SQL query asynchronously.</span>

<span class="sd">                Args:</span>
<span class="sd">                    cdm: CdmEngineFactory instance.</span>
<span class="sd">                    sqldict: Optional key from ``CDMSQL`` to pick a canned query.</span>
<span class="sd">                    query: Raw SQL string (used if provided).</span>
<span class="sd">                    chunksize: Unused; kept for future streaming support.</span>

<span class="sd">        Returns:</span>
<span class="sd">                    SQLAlchemy AsyncResult.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sqldict</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">CDMSQL</span><span class="p">[</span><span class="n">sqldict</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Query must be a non-empty string.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">cdm</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">result_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a Result to a DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: SQLAlchemy Result or AsyncResult.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame of result mappings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_of_dicts</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">mappings</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a list of dictionaries to a DataFrame.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_dicts</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">list_of_dicts</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdm</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;person&quot;</span><span class="p">,</span> <span class="n">query_name</span><span class="o">=</span><span class="s2">&quot;PE02&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch a query from OHDSI QueryLibrary and execute it.</span>

<span class="sd">        Args:</span>
<span class="sd">            cdm: CdmEngineFactory instance.</span>
<span class="sd">            resource: Query resource subfolder (e.g., &quot;person&quot;).</span>
<span class="sd">            query_name: Query markdown file name (e.g., &quot;PE02&quot;).</span>

<span class="sd">        Returns:</span>
<span class="sd">            SQLAlchemy AsyncResult.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the markdown from the query library repository: https://github.com/OHDSI/QueryLibrary/blob/master/inst/shinyApps/QueryLibrary/queries/person/PE02.md</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
        <span class="n">alternate_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/master/inst/shinyApps/QueryLibrary/queries/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
        <span class="n">markdown</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">markdown</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">markdown</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">markdown</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Could not fetch query </span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2"> from QueryLibrary &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(status code </span><span class="si">{</span><span class="n">markdown</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
        <span class="c1"># extract SQL code block</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```sql&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="c1"># remove @cdm. and @vocab. references</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@cdm.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@vocab.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query </span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2"> is empty.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="vector.CdmVector.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span> <span class="n">sqldict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#vector.CdmVector.execute" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Execute a SQL query asynchronously.</p>
<pre><code>    Args:
        cdm: CdmEngineFactory instance.
        sqldict: Optional key from ``CDMSQL`` to pick a canned query.
        query: Raw SQL string (used if provided).
        chunksize: Unused; kept for future streaming support.
</code></pre>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQLAlchemy AsyncResult.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vector.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdm</span><span class="p">,</span> <span class="n">sqldict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute a SQL query asynchronously.</span>

<span class="sd">            Args:</span>
<span class="sd">                cdm: CdmEngineFactory instance.</span>
<span class="sd">                sqldict: Optional key from ``CDMSQL`` to pick a canned query.</span>
<span class="sd">                query: Raw SQL string (used if provided).</span>
<span class="sd">                chunksize: Unused; kept for future streaming support.</span>

<span class="sd">    Returns:</span>
<span class="sd">                SQLAlchemy AsyncResult.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sqldict</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">CDMSQL</span><span class="p">[</span><span class="n">sqldict</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Query must be a non-empty string.&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">cdm</span><span class="o">.</span><span class="n">session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vector.CdmVector.query_library" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">query_library</span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s1">&#39;person&#39;</span><span class="p">,</span> <span class="n">query_name</span><span class="o">=</span><span class="s1">&#39;PE02&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#vector.CdmVector.query_library" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Fetch a query from OHDSI QueryLibrary and execute it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>cdm</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>CdmEngineFactory instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>resource</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Query resource subfolder (e.g., "person").</p>
              </div>
            </td>
            <td>
                  <code>&#39;person&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>query_name</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Query markdown file name (e.g., "PE02").</p>
              </div>
            </td>
            <td>
                  <code>&#39;PE02&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQLAlchemy AsyncResult.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vector.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">query_library</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cdm</span><span class="p">,</span> <span class="n">resource</span><span class="o">=</span><span class="s2">&quot;person&quot;</span><span class="p">,</span> <span class="n">query_name</span><span class="o">=</span><span class="s2">&quot;PE02&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch a query from OHDSI QueryLibrary and execute it.</span>

<span class="sd">    Args:</span>
<span class="sd">        cdm: CdmEngineFactory instance.</span>
<span class="sd">        resource: Query resource subfolder (e.g., &quot;person&quot;).</span>
<span class="sd">        query_name: Query markdown file name (e.g., &quot;PE02&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        SQLAlchemy AsyncResult.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the markdown from the query library repository: https://github.com/OHDSI/QueryLibrary/blob/master/inst/shinyApps/QueryLibrary/queries/person/PE02.md</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/refs/heads/master/inst/shinyApps/QueryLibrary/queries/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
    <span class="n">alternate_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://raw.githubusercontent.com/OHDSI/QueryLibrary/master/inst/shinyApps/QueryLibrary/queries/</span><span class="si">{</span><span class="n">resource</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2">.md&quot;</span>
    <span class="n">markdown</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">markdown</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">markdown</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alternate_url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">markdown</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not fetch query </span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2"> from QueryLibrary &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(status code </span><span class="si">{</span><span class="n">markdown</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>
    <span class="c1"># extract SQL code block</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```sql&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;```&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c1"># remove @cdm. and @vocab. references</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@cdm.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;@vocab.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Query </span><span class="si">{</span><span class="n">query_name</span><span class="si">}</span><span class="s2"> is empty.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cdm</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="vector.CdmVector.result_to_df" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">result_to_df</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></code>

<a href="#vector.CdmVector.result_to_df" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Convert a Result to a DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>result</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>SQLAlchemy Result or AsyncResult.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>pandas.DataFrame of result mappings.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src/pyomop/vector.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">result_to_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a Result to a DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        result: SQLAlchemy Result or AsyncResult.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame of result mappings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list_of_dicts</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">mappings</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a list of dictionaries to a DataFrame.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_dicts</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">list_of_dicts</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<a id="sqldict"></a>
    <div class="doc doc-contents first">

        <p>Predefined OMOP SQL snippets from the OHDSI Query Library.</p>
<p>This module exposes a small dictionary of named SQL queries that can be used
for demos, tests, or quick analytics over a CDM instance.</p>
<p>Source: https://github.com/OHDSI/QueryLibrary/tree/master/inst/shinyApps/QueryLibrary/queries</p>










<div class="doc doc-children">












  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Maintained by <a href="https://github.com/dermatologist">dermatologist</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/dermatologist/pyomop" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/pyomop" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/beapen" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://nuchange.ca" target="_blank" rel="noopener" title="nuchange.ca" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M277.8 8.6c-12.3-11.4-31.3-11.4-43.5 0l-224 208c-9.6 9-12.8 22.9-8 35.1S18.8 272 32 272h16v176c0 35.3 28.7 64 64 64h288c35.3 0 64-28.7 64-64V272h16c13.2 0 25-8.1 29.8-20.3s1.6-26.2-8-35.1zM240 320h32c26.5 0 48 21.5 48 48v96H192v-96c0-26.5 21.5-48 48-48"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>