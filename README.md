# pyomop: OMOP Swiss Army Knife ðŸ”§


[![Release](https://img.shields.io/github/v/release/dermatologist/pyomop)](https://img.shields.io/github/v/release/dermatologist/pyomop)
[![Build status](https://img.shields.io/github/actions/workflow/status/dermatologist/pyomop/pytest.yml?branch=develop)](https://github.com/dermatologist/pyomop/actions/workflows/pytest.yml?query=branch%3Adevelop)
[![codecov](https://codecov.io/gh/dermatologist/pyomop/branch/develop/graph/badge.svg)](https://codecov.io/gh/dermatologist/pyomop)
[![Commit activity](https://img.shields.io/github/commit-activity/m/dermatologist/pyomop)](https://img.shields.io/github/commit-activity/m/dermatologist/pyomop)
[![License](https://img.shields.io/github/license/dermatologist/pyomop)](https://img.shields.io/github/license/dermatologist/pyomop)
[![Downloads](https://img.shields.io/pypi/dm/pyomop)](https://pypi.org/project/pyomop)
[![Documentation](https://badgen.net/badge/icon/documentation?icon=libraries&label)](https://dermatologist.github.io/pyomop/)
<!-- gh-dependents-info-used-by-start -->
[![Generated by github-dependents-info](https://img.shields.io/static/v1?label=Used%20by&message=2&color=informational&logo=slickpic)](https://github.com/dermatologist/pyomop/blob/develop/docs/github-dependents-info.md)<!-- gh-dependents-info-used-by-end -->


## âœ¨ Overview

**pyomop** is your OMOP Swiss Army Knife ðŸ”§ for working with [OHDSI](https://www.ohdsi.org/) OMOP Common Data Model (CDM) v5.4 or v6 compliant databases using SQLAlchemy as the ORM. It supports converting query results to pandas DataFrames for machine learning pipelines and provides utilities for working with OMOP vocabularies. Table definitions are based on the [omop-cdm](https://github.com/thehyve/omop-cdm) library. Pyomop is designed to be a lightweight, easy-to-use library for researchers and developers experimenting and testing with OMOP CDM databases. It can be used both as a commandline tool and as an imported library in your code.

- Supports SQLite, PostgreSQL, and MySQL. CDM and Vocab tables are created in the same schema. (See usage below for more details)
- LLM-based natural language queries via llama-index. [Usage](examples/llm_example.py).
- ðŸ”¥ FHIR to OMOP conversion utilities. (See usage below for more details)
- Execute [QueryLibrary](https://github.com/OHDSI/QueryLibrary). (See usage below for more details)

Please â­ï¸ If you find this project useful!

## Installation

**Stable release:**
```
pip install pyomop
```

**Development version:**
```
git clone https://github.com/dermatologist/pyomop.git
cd pyomop
pip install -e .
```

**LLM support:**
```
pip install pyomop[llm]
```
See [llm_example.py](examples/llm_example.py) for usage.

## Docker

* A [docker-compose](/docker-compose.yml) is provided to quickly set up an environment with postgrs, [webapi](https://github.com/OHDSI/WebAPI), [atlas](https://github.com/OHDSI/atlas) and a [sql script](/examples/webapi_source.sql) to create a source in webapi. The script can be run using the `psql` command line tool or via the webapi UI. Please refresh after running the script by sending a request to /WebAPI/source/refresh.

## ðŸ”§ Usage


## ðŸ”§ Usage

### 1. Basic Usage: Connecting and Creating Data

Initialize the CDM engine and create a session. By default, `CdmEngineFactory` creates a local SQLite database for testing.

```python
import asyncio
import datetime
from pyomop import CdmEngineFactory
from pyomop.cdm54 import Person, Base # Import CDM v5.4 models

async def main():
    # 1. Initialize Engine (Default: SQLite)
    cdm = CdmEngineFactory()
    # For Postgres/MySQL:
    # cdm = CdmEngineFactory(db='pgsql', host='localhost', port=5432, user='...', pw='...', name='mydb', schema='omop')

    # 2. Initialize Tables (Create Schema)
    await cdm.init_models(Base.metadata)

    # 3. Create a Session and Add Data
    async with cdm.session() as session:
        async with session.begin():
            new_person = Person(
                person_id=100,
                year_of_birth=1990,
                month_of_birth=1,
                day_of_birth=1,
                birth_datetime=datetime.datetime(1990, 1, 1),
                gender_concept_id=8532, # Female
                race_concept_id=8527,   # White
                ethnicity_concept_id=38003564 # Not Hispanic
            )
            session.add(new_person)
        await session.commit()

        # Query Data
        person = await session.get(Person, 100)
        print(f"Found Person: ID={person.person_id}, Year={person.year_of_birth}")

        # Close session
        await session.close()

    # Dispose engine
    await cdm.engine.dispose()

if __name__ == "__main__":
    asyncio.run(main())
```

### 2. Vocabulary Management

Helper tools to load standard OMOP vocabularies and look up concepts.

```python
from pyomop import CdmVocabulary

async def vocab_usage(cdm):
    vocab = CdmVocabulary(cdm, version='cdm54')

    # Load Vocabulary from Folder (containing CONCEPT.csv, etc.)
    # await vocab.create_vocab('/path/to/vocab_csv_folder')

    # Lookup Concept by ID
    concept = await vocab.get_concept(8532)
    print(f"Concept 8532: {concept.concept_name} ({concept.domain_id})")

    # Lookup Concept by Code
    # Note: Requires loaded vocabulary
    # await vocab.get_concept_by_code('F', 'Gender')
```

### 3. Loading Data

**Using Eunomia (Sample Data)**:
Pyomop can download and load standard test datasets (Eunomia).

```python
from pyomop import EunomiaData

async def load_sample_data():
    eunomia = EunomiaData()
    # Download and load 'GiBleed' dataset (CDM v5.3)
    await eunomia.extract_load_data(
        eunomia.download_eunomia_data(dataset_name='GiBleed', cdm_version='5.3'),
        dataset_name='GiBleed',
        cdm_version='5.3'
    )
```

**Using Custom CSV Loader**:
Load your own CVS data into OMOP tables using a JSON mapping configuration.

```python
from pyomop import CdmCsvLoader

async def load_custom_data(cdm):
    loader = CdmCsvLoader(cdm)
    # See 'mapping.default.json' in source for format
    await loader.load(csv_path='patients.csv', mapping_path='my_mapping.json')
```

### 4. Analysis and Export

Convert SQL queries directly into Pandas DataFrames for analysis.

```python
from pyomop import CdmVector

async def analyze(cdm):
    vec = CdmVector()

    # Execute Raw SQL -> DataFrame
    result = await vec.execute(cdm, query="SELECT * FROM person LIMIT 5")
    df = vec.result_to_df(result)
    print(df.head())

    # Use OHDSI QueryLibrary
    # result = await vec.query_library(cdm, resource='person', query_name='PE02')
    # df = vec.result_to_df(result)
```


## ðŸ”¥ FHIR to OMOP mapping

pyomop can load FHIR Bulk Export (NDJSON) files into an OMOP CDM database.

- Sample datasets: https://github.com/smart-on-fhir/sample-bulk-fhir-datasets
- Remove any non-FHIR files (for example, `log.ndjson`) from the input folder.
- Download OMOP vocabulary CSV files (for example from OHDSI Athena) and place them in a folder.

Run:

```bash
pyomop --create --vocab ~/Downloads/omop-vocab/ --input ~/Downloads/fhir/
```

This will create an OMOP CDM in SQLite, load the vocabulary files, and import the FHIR data from the input folder and reconcile vocabulary, mapping source_value to concept_id. The mapping is defined in the `mapping.example.json` file. The default mapping is [here](src/pyomop/mapping.default.json). Mapping happens in 5 steps as implemented [here](src/pyomop/loader.py).

* Example using postgres (Docker)
```bash
pyomop --dbtype pgsql --host localhost --user postgres --pw mypass  --create --vocab ~/Downloads/omop-vocab/ --input ~/Downloads/fhir/
```

* FHIR to data frame mapping is done with [FHIRy](https://github.com/dermatologist/fhiry)
* Most of the code for this functionality was written by an LLM agent. The prompts used are [here](notes/prompt.md)

### Command-line

```text
  -c, --create                Create CDM tables (see --version).
  -t, --dbtype TEXT           Database Type for creating CDM (sqlite, mysql or
                              pgsql)
  -h, --host TEXT             Database host
  -p, --port TEXT             Database port
  -u, --user TEXT             Database user
  -w, --pw TEXT               Database password
  -v, --version TEXT          CDM version (cdm54 (default) or cdm6)
  -n, --name TEXT             Database name
  -s, --schema TEXT           Database schema (for pgsql)
  -i, --vocab TEXT            Folder with vocabulary files (csv) to import
  -f, --input DIRECTORY       Input folder with FHIR bundles or ndjson files.
  -e, --eunomia-dataset TEXT  Download and load Eunomia dataset (e.g.,
                              'GiBleed', 'Synthea')
  --eunomia-path TEXT         Path to store/find Eunomia datasets (uses
                              EUNOMIA_DATA_FOLDER env var if not specified)
  --connection-info           Display connection information for the database (For R package compatibility)
  --mcp-server                Start MCP server for stdio interaction
  --pyhealth-path TEXT        Path to export PyHealth compatible CSV files
  --help                      Show this message and exit.
```

## MCP Server

pyomop includes an MCP (Model Context Protocol) server that exposes tools for interacting with OMOP CDM databases. This allows MCP clients to create databases, load data, and execute SQL statements.

<p align="center">
  <img src="https://github.com/dermatologist/pyomop/blob/develop/notes/pyomop-mcp.gif" />
</p>

### Starting the MCP Server

To start the MCP server for stdio interaction:

```bash
# Using the main CLI
pyomop --mcp-server

```

#### Usage with MCP Clients

The server communicates via stdio and can be used with any MCP-compatible client. Example configuration for [vscode](/.vscode/mcp.json):

```json
{
  "servers": {
      "pyomop": {
      "command": "uv",
      "args": ["run", "pyomop", "--mcp-server"]
    }
  }
}
```
* *If the vocabulary is not installed locally or advanced vocabulary support is required from Athena, it is recommended to combine [omop_mcp](https://github.com/OHNLP/omop_mcp) with PyOMOP.*


#### Available MCP Tools

- **create_cdm**: Create an empty CDM database
- **create_eunomia**: Add Eunomia sample dataset
- **get_table_columns**: Get column names for a specific table
- **get_single_table_info**: Get detailed table information, including foreign keys
- **get_usable_table_names**: Get a list of all available table names
- **run_sql**: Execute SQL statements with error handling

* create_cdm and create_eunomia support only local sqlite databases to avoid inadvertent data loss in production databases.
#### Available Prompts

- **query_execution_steps**: Provides step-by-step guidance for executing database queries based on free text instructions

### Eunomia import and cohort creation
```
pyomop -e Synthea27Nj -v 5.4 --connection-info
pyomop -e GiBleed -v 5.3 --connection-info
```

## PyHealth and PLP Compatibility (For Machine Learning pipelines)

pyomop supports exporting OMOP CDM data (to `--pyhealth-path`) in a format compatible with [PyHealth](https://github.com/sunlabuiuc/PyHealth), a machine learning library for healthcare data analysis ([See Notebook](/examples/pyhealth.ipynb) and usage below). Additionally, you can export the connection information for use with the various R packages such as [PatientLevelPrediction](https://ohdsi.github.io/PatientLevelPrediction/) using the `--connection-info` option.

```bash
pyomop -e GiBleed -v 5.3 --connection-info --pyhealth-path ~/pyhealth
```

## Additional Tools

- **Convert FHIR to pandas DataFrame:** [fhiry](https://github.com/dermatologist/fhiry)
- **.NET and Golang OMOP CDM:** [.NET](https://github.com/dermatologist/omopcdm-dot-net), [Golang](https://github.com/E-Health/gocdm)

## Supported Databases

- PostgreSQL
- MySQL
- SQLite

## Environment Variables for Database Connection

You can configure database connection parameters using environment variables. These will be used as defaults by pyomop and the MCP server:

- `PYOMOP_DB`: Database type (`sqlite`, `mysql`, `pgsql`)
- `PYOMOP_HOST`: Database host
- `PYOMOP_PORT`: Database port
- `PYOMOP_USER`: Database user
- `PYOMOP_PW`: Database password
- `PYOMOP_SCHEMA`: Database schema (for PostgreSQL)

Example usage:

```bash
export PYOMOP_DB=pgsql
export PYOMOP_HOST=localhost
export PYOMOP_PORT=5432
export PYOMOP_USER=postgres
export PYOMOP_PW=mypass
export PYOMOP_SCHEMA=omop
```
These environment variables will be checked before assigning default values for database connection in pyomop and MCP server tools.

## Contributing

Pull requests are welcome! See [CONTRIBUTING.md](CONTRIBUTING.md).

## Contributors

- [Bell Eapen](https://nuchange.ca) [![Twitter Follow](https://img.shields.io/twitter/follow/beapen?style=social)](https://twitter.com/beapen)


